<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>神獸七十二型人格 測驗＋AI智能分析</title>
  <meta name="description" content="六獸人格AI分析｜金錢卦五行整合｜即時雷達圖＋智能報告" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root { --brand: #b6822b; }
    body { background: radial-gradient(circle at top left, #fffaf4, #f6f3ea); }
    .brand { color: var(--brand); }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .slider { accent-color: var(--brand); }
    
    /* 新增：設定面板的滑動動畫 */
    .slide-toggle {
        transition: all 0.3s ease-in-out;
        overflow: hidden;
        max-height: 1000px; /* 一個足夠大的值 */
    }
    .slide-toggle.hidden {
        max-height: 0;
        padding-top: 0;
        padding-bottom: 0;
        margin-top: 0;
        margin-bottom: 0;
        opacity: 0;
    }

    /* 載入動畫 */
    .spinner { animation: spin 1.5s linear infinite; display: inline-block; font-size: 2em; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loading-dots:after { content: '.'; animation: dots 1.5s steps(5, end) infinite; }
    @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
    
    /* 進度條 */
    .progress-container { width: 100%; background-color: #e5e7eb; border-radius: 10px; margin: 10px 0; overflow: hidden; }
    .progress-bar { height: 8px; background: linear-gradient(90deg, #b6822b, #d4a017); border-radius: 10px; transition: width 0.4s ease; width: 0%; }
    
    /* 神獸超人類別 */
    .superhero-card { border-radius: 12px; padding: 8px; margin: 6px 0; background: linear-gradient(135deg, #e8f4fd, #f0f9ff); border: 2px solid #2b6cb0; }
    .superhero-title { font-size: 1.2em; font-weight: bold; color: #2b6cb0; margin-bottom: 4px; }
    .superhero-ability { background: rgba(43, 108, 176, 0.1); padding: 4px; border-radius: 6px; margin: 4px 0; font-weight: bold; color: #2c5282; font-size: 1.0em; }
    .superhero-desc { font-size: 1.0em; color: #666; line-height: 1.3; }
    
    /* AI分析區塊 */
    .ai-analysis-section { background: linear-gradient(135deg, #f8f9fa, #ffffff); border: 1px solid #e9ecef; border-radius: 12px; padding: 12px; margin: 8px 0; }
    .ai-analysis-header { display: flex; align-items: center; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid #e9ecef; }
    .ai-analysis-icon { font-size: 1.5em; margin-right: 8px; }
    .ai-analysis-title { color: #2d3748; font-weight: bold; font-size: 1.2em; }
    .ai-analysis-content { font-size: 1.0em; color: #4a5568; line-height: 1.5; }
    .ai-analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 8px; margin-top: 12px; }
    .ai-analysis-item { background: white; padding: 8px; border-radius: 6px; border-left: 4px solid #b6822b; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .ai-analysis-item-title { font-weight: bold; color: #2d3748; margin-bottom: 4px; font-size: 1.0em; }
    .ai-analysis-item-content { font-size: 0.95em; color: #718096; line-height: 1.4; }
    
    /* 載入狀態 */
    .ai-loading { text-align: center; padding: 20px; color: #718096; background: linear-gradient(135deg, #f8f9fa, #ffffff); border-radius: 12px; border: 2px dashed #e5e7eb; }

    .print-only { display: none; }
    @media screen {
      #radar { width: 100% !important; height: 300px !important; }
      body { font-size: 16px; } /* 螢幕模式字體放大 */
      h1 { font-size: 2.5em; }
      h2 { font-size: 1.5em; }
      p, li, div { font-size: 1.0em; }
    }
    
    /* ================================================= */
    /* ========= 🖨️ 列印樣式 - 全新美化版 🖨️ ========= */
    /* ================================================= */
    @media print { 
      .no-print { display: none !important; } 
      body { background: white !important; font-size: 14px !important; color: black !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      main { max-width: 100% !important; padding: 10px !important; margin: 0 !important; }
      .card { box-shadow: none !important; border: 1px solid #ddd !important; break-inside: avoid; page-break-inside: avoid; }
      #result { display: grid !important; grid-template-columns: 45% 55% !important; gap: 10px !important; margin-bottom: 10px !important; }
      #radar-container { position: relative; width: 100% !important; height: 250px !important; padding-bottom: 0 !important; }
      #radar { position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; display: block !important; }
      .ai-analysis-content { font-size: 14px !important; line-height: 1.4 !important; }
      h1, h2 { color: var(--brand) !important; margin-bottom: 10px !important; font-weight: bold !important; }
      h2 { font-size: 18px !important; border-bottom: 2px solid var(--brand); padding-bottom: 4px; }
      .print-header { display: block !important; text-align: center; margin-bottom: 15px; padding: 15px !important; border: 2px solid var(--brand); border-radius: 12px; background: #fffaf4 !important; position: relative; page-break-after: avoid; box-shadow: 0 4px 12px rgba(182, 130, 43, 0.15); }
      .header-top-border { position: absolute; top: 0; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, var(--brand), #d4a017) !important; border-top-left-radius: 10px; border-top-right-radius: 10px; }
      .header-main-content { display: flex !important; justify-content: space-between; align-items: center; padding: 15px 8px 10px 8px; border-bottom: 1px solid #e5e7eb; }
      .header-left, .header-right { display: flex !important; align-items: center; gap: 8px; flex: 1; }
      .header-right { justify-content: flex-end; }
      .print-logo-img, .print-qrcode-img { width: 60px !important; height: 60px !important; border: 2px solid #d4a017; border-radius: 8px; padding: 3px; background: white; object-fit: contain; }
      .logo-text, .qrcode-text { text-align: left; }
      .qrcode-text { text-align: right; }
      .print-logo-title, .print-qrcode-title { font-size: 14px !important; font-weight: bold; color: var(--brand); }
      .print-logo-subtitle, .print-qrcode-subtitle { font-size: 10px !important; color: #555; line-height: 1.3; }
      .header-title-container { padding: 15px 0; }
      .report-main-title { font-size: 30px !important; font-weight: 900 !important; color: var(--brand) !important; margin: 0 !important; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); letter-spacing: 2px; font-family: 'Microsoft JhengHei', '微軟正黑體', sans-serif; }
      .report-subtitle { font-size: 16px !important; color: #333 !important; margin-top: 6px !important; font-weight: 600; }
      .print-date { text-align: center; font-size: 12px !important; color: #777 !important; margin-top: 8px; border-top: 1px solid #e5e7eb; padding-top: 8px; }
      #superheroReport { margin-top: 0 !important; padding: 8px !important; break-inside: avoid; page-break-before: auto; }
      #superheroReport h2 { font-size: 16px !important; margin-bottom: 6px !important; }
      .superhero-card { padding: 6px !important; margin: 0 !important; }
      .superhero-title { font-size: 1.1em !important; margin-bottom: 3px !important; }
      .superhero-ability, .superhero-desc, .superhero-local { font-size: 12px !important; line-height: 1.2 !important; padding: 3px !important; margin: 3px 0 !important; }
      #aiReport { display: block !important; page-break-before: auto; margin-top: 15px !important; }
    }
  </style>
</head>
<body class="text-slate-800">
<main class="max-w-5xl mx-auto p-4 sm:p-6">
  <header class="mb-4 flex justify-between items-center no-print">
    <div class="flex items-center gap-3">
      <img src="img/logo.png" class="h-10 w-auto rounded" alt="仙人指路 Logo" />
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold brand">神獸七十二型人格 測驗＋AI智能分析</h1>
        <p class="text-sm text-slate-600">六獸雷達圖・主型解析・三欄建議・AI分析報告</p>
      </div>
    </div>
    <button id="toggleSettingsBtn" type="button" class="no-print p-2 rounded-full hover:bg-amber-100 transition">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>
  </header>

  <form id="reportSettingsForm" class="card p-4 mb-4 no-print slide-toggle hidden">
    <h2 class="font-bold mb-3">⚙️ 報表資訊設定 (資訊將自動儲存於您的瀏覽器)</h2>
    <div class="space-y-4 text-sm">
      <div class="flex items-center gap-4">
        <div>
          <label for="qrCodeUploader" class="font-semibold text-slate-700 block mb-1">上傳 QR Code 圖片：</label>
          <input type="file" id="qrCodeUploader" accept="image/*" class="text-slate-600">
        </div>
        <div>
            <label class="font-semibold text-slate-700 block mb-1">圖片預覽：</label>
            <img id="qrCodePreview" src="https://via.placeholder.com/80x80.png?text=QR+Code" alt="QR Code 預覽" class="w-20 h-20 border rounded p-1 bg-white object-contain">
        </div>
      </div>
      <div>
        <label for="contactTitle" class="font-semibold text-slate-700">聯絡標題：</label>
        <input type="text" id="contactTitle" class="w-full mt-1 p-2 border rounded">
      </div>
      <div>
        <label for="contactLine1" class="font-semibold text-slate-700">聯絡資訊 (第一行)：</label>
        <input type="text" id="contactLine1" class="w-full mt-1 p-2 border rounded">
      </div>
      <div>
        <label for="contactLine2" class="font-semibold text-slate-700">聯絡資訊 (第二行)：</label>
        <input type="text" id="contactLine2" class="w-full mt-1 p-2 border rounded">
      </div>
      <div>
        <label for="themeSelect" class="font-semibold text-slate-700 block mb-1">選擇色系主題：</label>
        <select id="themeSelect" class="w-full mt-1 p-2 border rounded">
          <option value="warm">暖色系</option>
          <option value="cool">冷色系</option>
          <option value="classic">經典系</option>
        </select>
      </div>
      <div>
        <label for="hueSlider" class="font-semibold text-slate-700 block mb-1">調整色調 (0-360)：</label>
        <input type="range" id="hueSlider" min="0" max="360" value="40" class="w-full mt-1 slider" oninput="applyHue(this.value)">
      </div>
    </div>
    <div class="mt-4">
      <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700 transition text-sm">儲存設定</button>
    </div>
  </form>

  <form id="form" class="card p-4 mb-4 no-print">
    <h2 class="font-bold mb-3">📋 請回答下列30題（1＝不同意，5＝非常同意）</h2>
    
    <!-- 新增：性別選擇 -->
    <div class="mb-4 p-3 bg-slate-50 rounded-lg">
      <label class="font-semibold text-slate-700 block mb-2">請選擇您的性別：</label>
      <div class="flex gap-4">
        <label class="flex items-center">
          <input type="radio" name="gender" value="male" class="mr-2" checked>
          男性
        </label>
        <label class="flex items-center">
          <input type="radio" name="gender" value="female" class="mr-2">
          女性
        </label>
        <label class="flex items-center">
          <input type="radio" name="gender" value="other" class="mr-2">
          其他
        </label>
      </div>
    </div>
    
    <ol id="qWrap" class="space-y-3"></ol>
    <div class="mt-4 flex gap-3">
      <button type="submit" class="bg-amber-600 text-white px-5 py-2 rounded hover:bg-amber-700 transition">送出測驗</button>
      <button type="button" id="btnFillMid" class="border px-3 py-2 rounded hover:bg-gray-50 transition">全部填3</button>
    </div>
  </form>

  <div class="print-only print-header">
    <div class="header-top-border"></div>
    <div class="header-main-content">
      <div class="header-left">
        <img src="img/logo.png" alt="Logo" class="print-logo-img">
        <div class="logo-text">
            <div class="print-logo-title">仙人指路占卜研究學會</div>
            <div class="print-logo-subtitle">專業命理諮詢服務</div>
        </div>
      </div>
      <div class="header-right">
        <div class="qrcode-text">
            <div id="print-qrcode-title" class="print-qrcode-title"></div>
            <div id="print-qrcode-subtitle" class="print-qrcode-subtitle"></div>
        </div>
        <img id="print-qrcode-img" src="https://via.placeholder.com/80x80.png?text=QR+Code" alt="QR Code" class="print-qrcode-img">
      </div>
    </div>
    <div class="header-title-container">
      <h1 class="report-main-title">仙人指路神獸七十二型人格</h1>
      <p class="report-subtitle">個人化深度分析報告 (V45.0 最終穩定版)</p>
    </div>
    <div class="print-date">報告生成時間：<span id="report-date"></span></div>
  </div>

  <section id="result" class="grid lg:grid-cols-2 gap-4" style="display: none;">
    <div class="card p-4">
      <h2 class="font-bold mb-2">六獸能量雷達圖</h2>
      <div id="radar-container"><canvas id="radar"></canvas></div>
      <button class="mt-3 px-4 py-2 border rounded no-print hover:bg-gray-50 transition" onclick="printAnalysis()">🖨️ 列印分析報告</button>
    </div>
    <div class="card p-4" id="resultCard">
      <h2 class="font-bold mb-2">主型與三欄建議</h2>
      <div class="grid grid-cols-3 gap-3 items-start">
        <div id="beastSVG" class="w-full aspect-square"></div>
        <div class="col-span-2">
          <div id="mainBeastTitle" class="font-bold brand text-lg"></div>
          <div id="dualHint" class="text-sm text-slate-600 mt-1"></div>
          <div id="mainBeastSummary" class="mt-2 text-sm"></div>
        </div>
      </div>
      <hr class="my-2" />
      <div id="adviceCols" class="grid md:grid-cols-3 gap-2 text-sm"></div>
      <div class="mt-3 flex gap-2 no-print">
        <button id="btnShare" class="px-4 py-2 border rounded hover:bg-gray-50 transition">分享結果圖片</button>
        <button class="px-4 py-2 border rounded hover:bg-gray-50 transition" onclick="printAnalysis()">🖨️ 列印分析報告</button>
      </div>
    </div>
  </section>

  <section class="card p-4 mt-4" id="superheroReport" style="display: none;">
    <h2 class="font-bold mb-2">🦸‍♂️ 你的神獸超人身分</h2>
    <div id="superhero-display" class="superhero-card">
      <div id="superhero-name" class="superhero-title"></div>
      <div id="superhero-ability" class="superhero-ability"></div>
      <div id="superhero-mission" class="superhero-desc"></div>
      <div id="superhero-local" class="text-sm mt-2 font-bold text-blue-700"></div>
    </div>
  </section>

  <section class="card p-4 mt-4" id="aiReport" style="display: none;">
    <h2 class="font-bold mb-2">🤖 AI 智能個人化分析報告</h2>
    <p class="text-sm text-slate-600 mb-2">以下內容由仙人指路AI系統生成，融合金錢卦、五行、地支與心理視角。</p>
    <div id="ai-analysis-structured">
      <div class="ai-loading" id="ai-loading" style="display: none;">
        <div class="spinner">🔮</div>
        <p class="mt-2 text-lg font-semibold">AI 正在為您深度分析中<span class="loading-dots"></span></p>
        <p class="mt-1 text-sm text-gray-600">這可能需要 10-20 秒，請稍候</p>
        <div class="progress-container mt-3"><div class="progress-bar" id="progress-bar"></div></div>
        <div class="mt-2 text-xs text-gray-500" id="loading-step">初始化分析引擎...</div>
      </div>
      <div id="ai-analysis-content">
        <div class="ai-analysis-section">
          <div class="ai-analysis-header"><div class="ai-analysis-icon">🎭</div><div class="ai-analysis-title">人格特質分析</div></div>
          <div class="ai-analysis-content" id="ai-personality"><div class="text-gray-500 text-center py-3">點擊「生成深度分析」獲取詳細解析</div></div>
        </div>
        <div class="ai-analysis-section">
          <div class="ai-analysis-header"><div class="ai-analysis-icon">⚡</div><div class="ai-analysis-title">能量優勢分析</div></div>
          <div class="ai-analysis-content" id="ai-strengths"><div class="text-gray-500 text-center py-3">點擊「生成深度分析」獲取詳細解析</div></div>
        </div>
        <div class="ai-analysis-section">
          <div class="ai-analysis-header"><div class="ai-analysis-icon">📈</div><div class="ai-analysis-title">成長發展建議</div></div>
          <div class="ai-analysis-grid">
            <div class="ai-analysis-item"><div class="ai-analysis-item-title">職場發展</div><div class="ai-analysis-item-content" id="ai-career">點擊「生成深度分析」獲取職場建議</div></div>
            <div class="ai-analysis-item"><div class="ai-analysis-item-title">人際關係</div><div class="ai-analysis-item-content" id="ai-relationships">點擊「生成深度分析」獲取人際建議</div></div>
            <div class="ai-analysis-item"><div class="ai-analysis-item-title">個人成長</div><div class="ai-analysis-item-content" id="ai-growth">點擊「生成深度分析」獲取成長建議</div></div>
          </div>
        </div>
        <div class="ai-analysis-section">
          <div class="ai-analysis-header"><div class="ai-analysis-icon">💰</div><div class="ai-analysis-title">五行金錢卦解析</div></div>
          <div class="ai-analysis-content" id="ai-money"><div class="text-gray-500 text-center py-3">點擊「生成深度分析」獲取金錢卦解析</div></div>
        </div>
      </div>
    </div>
    <div class="flex gap-2 no-print mt-3">
      <button id="btnAI" class="px-4 py-2 border rounded bg-amber-500 text-white hover:bg-amber-600 transition">生成深度分析</button>
      <button id="btnRetry" class="px-4 py-2 border rounded bg-gray-200 hover:bg-gray-300 transition" style="display:none;">重新分析</button>
      <button class="px-4 py-2 border rounded hover:bg-gray-50 transition" onclick="printAnalysis()">🖨️ 列印完整報告</button>
    </div>
  </section>

  <footer class="text-center text-xs text-slate-500 mt-6 no-print">
    <div class="flex justify-center items-center gap-4 mb-1">
      <span>© 2025 仙人指路占卜研究學會</span><span>|</span><span>Line: @immortalguiide</span>
    </div>
    <p>測驗僅供覺察與教學用途</p>
  </footer>
</main>

<script>
// ========== 報告日期設定 ==========
document.getElementById('report-date').textContent = new Date().toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

// ========== 新增：設定面板開關邏輯 ==========
const toggleBtn = document.getElementById('toggleSettingsBtn');
const settingsPanel = document.getElementById('reportSettingsForm');

toggleBtn.addEventListener('click', () => {
    settingsPanel.classList.toggle('hidden');
});

// ========== 報表資訊設定的儲存與載入邏輯 ==========
const settingsForm = document.getElementById('reportSettingsForm');
const qrCodeUploader = document.getElementById('qrCodeUploader');
const qrCodePreview = document.getElementById('qrCodePreview');
const contactTitleInput = document.getElementById('contactTitle');
const contactLine1Input = document.getElementById('contactLine1');
const contactLine2Input = document.getElementById('contactLine2');
const themeSelect = document.getElementById('themeSelect');
const hueSlider = document.getElementById('hueSlider');
const DEFAULT_QR_PLACEHOLDER = 'https://via.placeholder.com/80x80.png?text=QR+Code';

// 處理圖片上傳
qrCodeUploader.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            qrCodePreview.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }
});

// 儲存設定
settingsForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const settings = {
    qrDataUrl: qrCodePreview.src,
    title: contactTitleInput.value,
    line1: contactLine1Input.value,
    line2: contactLine2Input.value,
    theme: themeSelect.value,
    hue: hueSlider.value
  };
  localStorage.setItem('reportContactSettings', JSON.stringify(settings));
  applyTheme(settings.theme, settings.hue);
  alert('設定已儲存！');
});

// 頁面載入時，讀取並填入已儲存的設定
function loadSettings() {
  const savedSettings = JSON.parse(localStorage.getItem('reportContactSettings'));
  if (savedSettings) {
    qrCodePreview.src = savedSettings.qrDataUrl || DEFAULT_QR_PLACEHOLDER;
    contactTitleInput.value = savedSettings.title || '掃碼預約一對一諮詢';
    contactLine1Input.value = savedSettings.line1 || 'Line ID: @immortalguiide';
    contactLine2Input.value = savedSettings.line2 || '專業諮詢預約';
    themeSelect.value = savedSettings.theme || 'warm';
    hueSlider.value = savedSettings.hue || 40;
    applyTheme(savedSettings.theme || 'warm', savedSettings.hue || 40);
  } else {
    // 設置預設值
    qrCodePreview.src = DEFAULT_QR_PLACEHOLDER;
    contactTitleInput.value = '掃碼預約一對一諮詢';
    contactLine1Input.value = 'Line ID: @immortalguiide';
    contactLine2Input.value = '專業諮詢預約';
    themeSelect.value = 'warm';
    hueSlider.value = 40;
    applyTheme('warm', 40);
  }
}
loadSettings();

// 新增：應用色系主題與色調
function applyTheme(theme, hue) {
  const root = document.documentElement;
  let baseHue = parseInt(hue);
  switch (theme) {
    case 'warm':
      root.style.setProperty('--brand', `hsl(${baseHue}, 70%, 45%)`);
      document.body.style.background = 'radial-gradient(circle at top left, #fffaf4, #f6f3ea)';
      break;
    case 'cool':
      root.style.setProperty('--brand', `hsl(${baseHue + 180}, 70%, 45%)`);
      document.body.style.background = 'radial-gradient(circle at top left, #e8f4fd, #f0f9ff)';
      break;
    case 'classic':
      root.style.setProperty('--brand', `hsl(${baseHue + 240}, 20%, 40%)`);
      document.body.style.background = 'radial-gradient(circle at top left, #f7fafc, #edf2f7)';
      break;
  }
  // 更新進度條顏色
  const progressBar = document.querySelector('.progress-bar');
  progressBar.style.background = `linear-gradient(90deg, ${getComputedStyle(root).getPropertyValue('--brand')}, #d4a017)`;
}

// 新增：即時應用色調滑塊
function applyHue(hue) {
  const theme = themeSelect.value;
  applyTheme(theme, hue);
  const settings = JSON.parse(localStorage.getItem('reportContactSettings') || '{}');
  settings.hue = hue;
  localStorage.setItem('reportContactSettings', JSON.stringify(settings));
}

// ========== 列印功能（已修復雷達圖問題） ==========
function printAnalysis() {
  // 先轉換雷達圖為圖片
  convertChartToImage();

  const savedSettings = JSON.parse(localStorage.getItem('reportContactSettings') || '{}');
  const qrDataUrl = savedSettings.qrDataUrl || DEFAULT_QR_PLACEHOLDER;
  const title = savedSettings.title || '掃碼預約一對一諮詢';
  const line1 = savedSettings.line1 || 'Line ID: @immortalguiide';
  const line2 = savedSettings.line2 || '專業諮詢預約';

  document.getElementById('print-qrcode-img').src = qrDataUrl;
  document.getElementById('print-qrcode-title').textContent = title;
  document.getElementById('print-qrcode-subtitle').innerHTML = `${line1}${line2 ? '<br>' + line2 : ''}`;

  // 延遲列印以確保圖片載入
  setTimeout(() => {
    window.print();
  }, 500);
}

// 新增：將雷達圖轉為圖片以解決列印問題
function convertChartToImage() {
  const canvas = document.getElementById('radar');
  if (canvas) {
    html2canvas(canvas, { scale: 2 }).then((capturedCanvas) => {  // 使用更高解析度
      const imgData = capturedCanvas.toDataURL('image/png');
      const img = document.createElement('img');
      img.src = imgData;
      img.style.width = '100%';
      img.style.height = 'auto';
      const container = document.getElementById('radar-container');
      container.innerHTML = '';  // 清空原 canvas
      container.appendChild(img);
    }).catch((error) => {
      console.error('圖表轉換失敗:', error);
    });
  }
}

// 監聽 beforeprint 事件（額外確保）
window.addEventListener('beforeprint', convertChartToImage);

// ========== 神獸超人對照資料 (已擴充內容並加入性別差異) ==========
const superheroData = {
  '青龍': {
    male: {name:'創意飛龍超人', ability:'🦸‍♂️ 超能力：靈感爆發 + 快速應變 + 突破框架', mission:'🎯 專屬任務：創新專案發起人、危機處理專家、新領域開拓者', localName:'台灣點子王', description:'你就像台灣的創新引擎，總能想出讓人驚艷的點子！'},
    female: {name:'創意飛龍女俠', ability:'🦸‍♀️ 超能力：靈感爆發 + 直覺洞察 + 跨界融合', mission:'🎯 專屬任務：創意策劃師、團隊協調者、美感引導者', localName:'台灣創意女神', description:'你是台灣的創意女神，總能將靈感轉化為動人的作品！'},
    other: {name:'創意飛龍使者', ability:'🦸 超能力：靈感爆發 + 多元視角 + 跨界連結', mission:'🎯 專屬任務：創意橋樑、多元文化融合者、創新催化劑', localName:'台灣創意大使', description:'你是台灣的創意大使，用多元視角連結不同領域！'},
    analysis: {
      male: {
        personality: '青龍型人格的你，內心蘊藏著一股生生不息的創造活水。你的思維如同春雷破曉，總能在平凡中看見不凡，在框架外找到新路。你不喜歡墨守成規，享受從無到有的創造過程，腦中時常有無數個「如果這樣會怎樣？」的念頭在翻騰。對你而言，世界不是一個固定的劇本，而是一個充滿無限可能的遊樂場，等待你去探索、去定義。',
        strengths: '你最大的優勢在於那無人能及的「靈感爆發力」與「靈活應變性」。當團隊陷入僵局時，你總能提出石破天驚的觀點，化解危機。你像一位高明的舵手，即便遇到突來的風暴也能迅速調整航向，找到新的航道。這種突破性的思維是你最寶貴的資產，讓你在變動快速的環境中如魚得水，成為團隊中不可或缺的創新催化劑。',
        career: '在職業選擇上，你如同翱翔的巨龍，最適合在需要源源不絕創意的領域發光發熱，例如廣告設計、產品開發、新創企業的開拓者，或是任何鼓勵打破常規、挑戰現狀的崗位。你需要一個能夠給予你高度自由度和發揮空間的舞台。切記，避免選擇過於僵化、重複性高的工作，那會扼殺你的天賦。',
        relationships: '情感世界裡，你需要的是新鮮感與共同成長的火花。一成不變的關係會讓你感到窒息。你嚮往能一起探索未知、嘗試新事物、激盪思想的伴侶。對你而言，最浪漫的事莫過於兩人一起把生活變成一場有趣的冒險。不過，也要學習在追求變化的同時，給予對方穩定的安全感，找到創新與承諾間的平衡點。',
        growth: '你的挑戰在於如何將天馬行空的創意「落地」。學習建立系統性的執行計畫、培養耐心與專注力至關重要。可以嘗試使用專案管理工具，將大目標拆解成小步驟，並設定明確的時程。另外，適時地沉澱與反思，而非一味追逐新點子，能讓你的創造力發揮得更長久、更有深度。',
        money: '金錢卦象顯示，你的財富密碼藏在「趨勢」與「創新」之中。你對新興產業、潛力科技有著敏銳的直覺，適合進行風險與回報較高的前瞻性投資。然而，你的挑戰在於避免因一時的靈感而衝動決策。建議你建立一個核心穩健的投資組合，再撥出一部分資金用於實現你的創意投資，並嚴格設立停損點，方能駕馭財富的浪潮。'
      },
      female: {
        personality: '青龍型人格的你，擁有豐富的想像力與敏銳的直覺。你的思維如同春日溪流，靈動而富有生命力，總能在平凡中發現美的可能，在困境中找到創新的出路。你享受創造的過程，喜歡將靈感轉化為具體的成果，無論是藝術作品、生活美學還是解決方案。對你而言，生活是一塊畫布，等待你用獨特的視角去描繪。',
        strengths: '你最大的優勢在於「靈感直覺」與「跨界融合能力」。你能夠感知到他人忽略的細節，並將不同領域的知識與美感巧妙地結合起來。在團隊中，你往往是創意的催化劑，能夠用獨特的視角啟發他人，並將抽象的點子轉化為具體可行的方案。你的存在，為團隊帶來活力與美感，是創意與實用之間的橋樑。',
        career: '在職業選擇上，你適合在需要創造力與美感的領域發揮所長，例如設計、藝術、教育、策劃或任何需要跨界整合的工作。你需要一個能夠尊重你創意、給予你發揮空間的環境。你的價值在於將美感與實用結合，創造出既有深度又有溫度的作品。避免過於機械化、缺乏創造空間的工作，那會限制你的天賦。',
        relationships: '在感情中，你追求的是心靈的共鳴與共同成長。你渴望與伴侶一起探索世界，分享彼此的夢想與靈感。對你而言，最美好的關係是兩個獨立靈魂的相互啟發與支持。你需要一個能夠欣賞你獨特視角、並願意與你一起創造美好生活的伴侶。同時，也要學習在追求理想的同時，包容現實的不完美。',
        growth: '你的成長課題在於「平衡理想與現實」。有時候，過於追求完美可能會讓你感到挫折。學習接受「足夠好」的標準，並在創意與可行性之間找到平衡點。建立規律的生活習慣與工作節奏，能夠幫助你更有效地將靈感轉化為成果。同時，也要學會保護自己的能量，避免過度投入而耗盡創意源泉。',
        money: '金錢卦象顯示，你的財富之道在於「美感經濟」與「知識變現」。你對美與品質的敏感度，能夠幫助你在設計、文化創意等領域找到商機。適合投資於能夠提升生活品質的項目，或將你的專業知識轉化為有價值的產品與服務。建議你建立多元的收入來源，並學習基本的財務管理，讓創意與財富相輔相成。'
      },
      other: {
        personality: '青龍型人格的你，擁有獨特的多元視角與創造力。你的思維不受傳統框架限制，能夠從不同角度看待問題，找到創新的解決方案。你享受探索未知，喜歡將不同的元素融合在一起，創造出全新的可能性。對你而言，世界是一個充滿多元可能性的畫布，等待你用獨特的視角去描繪。',
        strengths: '你最大的優勢在於「多元視角」與「跨界連結能力」。你能夠理解不同群體的需求，並在看似不相關的領域之間建立連結。在團隊中，你是創意的橋樑，能夠促進不同背景的人合作，激發出創新的火花。你的存在，為團隊帶來多元的視野與包容性，是創新與融合的催化劑。',
        career: '在職業選擇上，你適合在需要多元視角與跨界合作的領域發揮所長，例如跨文化溝通、創新顧問、多元文化策劃或任何需要連結不同領域的工作。你需要一個能夠尊重多元性、鼓勵創新的環境。你的價值在於將不同的觀點與資源整合起來，創造出更具包容性的解決方案。',
        relationships: '在感情中，你追求的是真誠的理解與深度的連結。你渴望與伴侶建立基於相互尊重與支持的關係，共同探索生活的多元可能性。對你而言，最美好的關係是兩個獨立個體的相互成長與支持。你需要一個能夠欣賞你獨特視角、並願意與你一起創造包容性關係的伴侶。',
        growth: '你的成長課題在於「建立清晰的個人邊界」。因為你能夠理解多元觀點，有時可能會在各種可能性之間迷失方向。學習明確自己的核心價值觀，並在保持開放的同时建立清晰的個人邊界。培養專注力，將多元的創意轉化為具體的行動，能夠幫助你更有效地實現目標。',
        money: '金錢卦象顯示，你的財富之道在於「多元經濟」與「跨界合作」。你對不同領域的敏感度，能夠幫助你在跨領域合作中找到獨特的商機。適合投資於具有社會包容性與文化多樣性的項目，或將你的跨界能力轉化為有價值的服務。建議你建立多元的投資組合，並關注具有社會影響力的投資機會。'
      }
    }
  },
  '朱雀': {
    male: {name:'熱情鳳凰超人', ability:'🦸‍♂️ 超能力：感染力場 + 溝通大師 + 激勵光環', mission:'🎯 專屬任務：團隊士氣充電站、公關溝通達人、教育推廣先鋒', localName:'台灣熱情大使', description:'你是台灣的人氣王，用熱情感染身邊的每一個人！'},
    female: {name:'熱情鳳凰女俠', ability:'🦸‍♀️ 超能力：情感共鳴 + 溝通藝術 + 溫暖療癒', mission:'🎯 專屬任務：情感支持者、團隊凝聚者、心靈療癒師', localName:'台灣暖心天使', description:'你是台灣的暖心天使，用真誠與溫暖照亮他人！'},
    other: {name:'熱情鳳凰使者', ability:'🦸 超能力：情感連結 + 多元溝通 + 社群凝聚', mission:'🎯 專屬任務：社群橋樑、情感支持者、多元文化推廣者', localName:'台灣情感連結者', description:'你是台灣的情感連結者，用真誠連結不同的心靈！'},
    analysis: {
      male: {
        personality: '朱雀型人格的你，生來就是舞台的焦點，人群中的發光體。你的內心燃燒著一團熱情的火焰，這股能量透過你的言談、舉止自然而然地散發出來，溫暖並感染著身邊的每一個人。你享受與人互動，渴望被看見、被聽見，並從中獲得能量。對你來說，生命是一場盛大的派對，而你就是那個邀請大家共舞的核心人物。',
        strengths: '你與生俱來的「溝通魅力」和「超凡感染力」是你最強大的武器。你善於用生動的語言、真誠的情感去打動人心，能輕易地化解尷尬、凝聚共識。在團隊中，你就像一顆小太陽，能驅散低迷的氣氛，激發夥伴的鬥志與潛能。建立人際網絡對你來說易如反掌，人們會不自覺地被你的熱情與真誠所吸引。',
        career: '你的天賦在於所有需要與「人」打交道的工作。公關、市場行銷、銷售、教育培訓、主持人、人力資源等領域都是你能大放異彩的舞台。你需要一份能讓你充分表達自我、與他人建立連結的工作。一個充滿互動、氣氛活躍的工作環境，遠比一份薪水優渥但枯燥乏味的工作更能讓你獲得成就感。',
        relationships: '在感情中，你是一個需要大量情感交流與肯定的浪漫主義者。甜言蜜語、溫暖的擁抱、真誠的讚美對你而言如同空氣般重要。你擅長製造浪漫與驚喜，也同樣渴望對方能給予熱情的回應。尋找一位同樣重視情感表達、願意與你分享生活點滴的伴侶至關重要。你需要的是靈魂的共舞，而非沉默的陪伴。',
        growth: '你的成長課題是學習「管理情緒」與「尋求內在平靜」。高度的情感敏感性是一把雙面刃，它讓你充滿魅力的同時，也可能讓你因外界的評價而情緒起伏。你需要學習在熱情奔放之餘，保留一個獨處的空間，傾聽內心的聲音，避免將自我價值完全建立在他人的認可之上。學會分辨哪些是自己的情緒，哪些是受他人的影響。',
        money: '從金錢卦來看，你的財富往往與你的「人脈」和「聲望」緊密相連。透過建立良好的合作關係、利用你的口才與溝通能力，往往能為你帶來意想不到的財富機會。投資自己，例如提升演說技巧、拓展社交圈，會是回報率最高的方式。理財上，你需要避免因一時的情緒或朋友推薦而做出衝動的投資決定，尋求專業建議能幫助你更穩健地累積財富。'
      },
      female: {
        personality: '朱雀型人格的你，擁有溫暖的心靈與敏銳的情感雷達。你天生就能感知他人的情緒，並用真誠的關懷去溫暖每一顆心。你的存在就像冬日裡的暖陽，能驅散陰霾，帶來希望。你享受與人建立深層的連結，從真誠的交流中獲得能量。對你來說，生命是一場愛的旅程，而你就是那個傳遞溫暖與希望的使者。',
        strengths: '你最大的優勢在於「情感共鳴能力」與「溫暖療癒力」。你能夠深入理解他人的感受，並用恰到好處的方式給予支持與鼓勵。在團隊中，你是情感的黏合劑，能夠化解衝突、凝聚共識。你的真誠與關懷，讓人們願意向你敞開心扉，你是團隊中不可或缺的心靈支柱。',
        career: '你的天賦在於所有需要關懷、支持與溝通的領域。心理諮商、教育、護理、人力資源、客戶服務等行業都非常適合你。你需要一份能夠讓你發揮同理心、幫助他人成長的工作。一個充滿人性關懷、重視團隊合作的工作環境，最能讓你感到滿足與成就感。',
        relationships: '在感情中，你是一個細膩而深情的伴侶。你重視情感的深度與品質，渴望建立穩定而親密的關係。對你而言，最美好的愛情是兩個靈魂的相互理解與支持。你需要一個能夠珍惜你的溫柔、並願意與你共同經營親密關係的伴侶。同時，也要學習在付出關愛的同時，照顧好自己的情感需求。',
        growth: '你的成長課題是「建立健康的情感邊界」。因為你太容易感知並承接他人的情緒，有時會感到心力交瘁。學習區分哪些是別人的情緒，哪些是自己的感受，並學會在必要時說「不」。培養獨處的能力，找到屬於自己的充電方式，能夠幫助你保持能量的平衡，避免情感透支。',
        money: '金錢卦象顯示，你的財富之道在於「關係經濟」與「心靈產業」。你對人際關係的敏感度，能夠幫助你在需要建立信任與連結的領域找到商機。適合從事教育、諮詢、療癒等能夠發揮你關懷特質的工作。理財上，你需要避免因情感因素而做出不理性的消費或投資決定，建立清晰的財務規劃能夠幫助你更穩健地管理財富。'
      },
      other: {
        personality: '朱雀型人格的你，擁有獨特的情感智慧與連結能力。你能夠理解不同背景的人的情感需求，並用真誠的態度建立深度的連結。你的存在就像一座橋樑，連結著不同的心靈與社群。你享受促進理解與和諧的過程，從中獲得深深的滿足感。對你來說，生命是一場促進理解與連結的旅程。',
        strengths: '你最大的優勢在於「多元情感理解」與「社群凝聚能力」。你能夠感知不同群體的情感需求，並促進彼此的理解與合作。在團隊中，你是情感的橋樑，能夠化解誤會、建立信任。你的包容與理解，讓人們願意向你敞開心扉，你是社群中不可或缺的和諧力量。',
        career: '你的天賦在於所有需要促進理解與連結的領域。社群工作、跨文化溝通、調解工作、多元文化教育等行業都非常適合你。你需要一份能夠讓你發揮連結能力、促進社會和諧的工作。一個重視多元性與包容性的工作環境，最能讓你感到成就感與意義。',
        relationships: '在感情中，你追求的是深度的理解與真誠的連結。你重視關係中的平等與尊重，渴望建立基於相互理解與支持的親密關係。對你而言，最美好的關係是兩個獨立個體在相互尊重基础上的深度連結。你需要一個能夠欣賞你連結能力、並願意與你共同創造包容性關係的伴侶。',
        growth: '你的成長課題是「平衡付出與自我照顧」。因為你擅長理解與支持他人，有時可能會忽略自己的情感需求。學習在關心他人的同時，也關注自己的內心世界，建立健康的情感邊界。培養自我覺察的能力，定期檢視自己的情感狀態，能夠幫助你保持能量的平衡與內心的和諧。',
        money: '金錢卦象顯示，你的財富之道在於「社群經濟」與「關係網絡」。你對社群需求的理解，能夠幫助你在社會企業、社群經營等領域找到商機。適合從事能夠促進社會連結與和諧的項目，或將你的連結能力轉化為有價值的服務。建議你關注具有社會影響力的投資機會，並建立多元的收入來源。'
      }
    }
  },
  '勾陳': {
    male: {name:'穩固城牆超人', ability:'🦸‍♂️ 超能力：可靠防護 + 細節掌控 + 執行力場', mission:'🎯 專屬任務：系統穩定守護者、品質把關專家、長期規劃師', localName:'台灣地基主', description:'你是台灣的穩定力量，像堅固的地基一樣可靠！'},
    female: {name:'穩固城牆女俠', ability:'🦸‍♀️ 超能力：細心守護 + 組織協調 + 穩定支持', mission:'🎯 專屬任務：系統維護者、品質守護者、團隊穩定劑', localName:'台灣守護天使', description:'你是台灣的守護天使，用細心與穩定支持著每個人！'},
    other: {name:'穩固城牆使者', ability:'🦸 超能力：系統思維 + 穩定建構 + 多元協調', mission:'🎯 專屬任務：系統架構師、穩定維護者、多元協調者', localName:'台灣系統守護者', description:'你是台灣的系統守護者，用穩定的力量建構更好的環境！'},
    analysis: {
      male: {
        personality: '勾陳型人格的你，是穩定與秩序的化身。你的內心有一座堅實的堡壘，凡事講求計畫、注重細節、信守承諾。你可能不是人群中最耀眼的那一個，但絕對是最讓人安心、最值得信賴的夥伴。你相信按部就班的力量，對混亂和不確定性感到不安。對你而言，生活的美好在於建立一個可預測、有條理且充滿安全感的環境。',
        strengths: '「極致的可靠性」與「強大的執行力」是你最核心的優勢。任何交付到你手中的任務，你都會以最高的標準、最嚴謹的態度去完成。你對細節的掌控力令人驚嘆，總能發現他人忽略的疏漏。在一個團隊中，你就是品質的最後一道防線，是確保計畫能從藍圖變為現實的關鍵支柱。你的存在，本身就是一種承諾。',
        career: '任何要求精準、穩定和責任感的工作都非常適合你。例如，專案管理、財務會計、法務、品管工程師、系統管理員等。你需要一個結構清晰、權責分明的工作環境。你的價值在於為組織提供穩定性，並確保每一個環節都準確無誤。你是優秀的守護者與執行者，能在已有的框架下將事情做到一百二十分。',
        relationships: '在情感關係中，你追求的是「長久而穩定的安全感」。你會用持續而務實的行動來表達關愛，而非華而不實的言語。對你來說，承諾重於泰山。一個可靠的肩膀、一個溫暖的家，是你對感情最深的期盼。你需要一個同樣重視家庭、理解你對穩定生活嚮往的伴侶。你的愛，是細水長流，是日復一日的守護。',
        growth: '你的成長關鍵在於學習「擁抱彈性」與「適度放手」。世界充滿了變化，過於堅持計畫有時會讓你錯失良機或倍感壓力。嘗試在你的計畫中保留一些彈性空間，學習接受「足夠好」而非「絕對完美」。偶爾放下對細節的掌控，授權給他人，不僅能讓你更輕鬆，也能發現新的可能性。',
        money: '金錢卦象顯示，你的理財天賦在於「穩健增值」與「風險規避」。你非常適合長期、有規律的儲蓄和投資計畫，例如定期定額投資藍籌股或指數型基金。你的耐心將會為你帶來豐厚的複利回報。你需要警惕的是過於保守，有時一些經過審慎評估的、略帶風險的機會也值得嘗試。建立一個攻守兼備的資產配置是你的理想路徑。'
      },
      female: {
        personality: '勾陳型人格的你，擁有細膩的心思與堅定的責任感。你重視秩序與穩定，擅長在混亂中建立條理，在變動中維持平衡。你的內心有一座溫暖而堅固的堡壘，為身邊的人提供安全感與支持。你可能不喜歡張揚，但你的存在本身就是一種穩定的力量。對你而言，生活的美好在於建立和諧、有序且充滿關懷的環境。',
        strengths: '你最大的優勢在於「細緻的觀察力」與「穩定的支持力」。你能夠注意到他人忽略的細節，並用務實的方式提供支持。在團隊中，你是穩定的基石，能夠在變動中維持秩序，在壓力下保持冷靜。你的細心與可靠性，讓人們願意將重要的任務託付給你，你是團隊中不可或缺的守護者。',
        career: '你的天賦在於所有需要細心、耐心與責任感的領域。行政管理、教育、護理、會計、品質管控等行業都非常適合你。你需要一個能夠讓你發揮組織能力、提供穩定支持的工作環境。你的價值在於為組織建立秩序與穩定，並確保每個細節都得到妥善的照顧。',
        relationships: '在感情中，你是一個細心而可靠的伴侶。你重視關係的穩定性與承諾，渴望建立長久而深厚的親密關係。對你而言，最美好的愛情是日復一日的相互支持與守護。你需要一個能夠珍惜你的細心、並願意與你共同經營穩定關係的伴侶。同時，也要學習在提供支持的同時，表達自己的情感需求。',
        growth: '你的成長課題是「學習放鬆」與「接受不完美」。因為你對秩序與完美的追求，有時可能會讓自己與他人感到壓力。學習接受生活中的不確定性，並在堅持原則的同時保持一定的彈性。培養放鬆的能力，學習享受生活中的小確幸，能夠幫助你保持內心的平衡與幸福感。',
        money: '金錢卦象顯示，你的財富之道在於「穩健理財」與「長期規劃」。你對風險的敏感度與對細節的關注，能夠幫助你在理財上做出明智的決策。適合建立長期的儲蓄與投資計畫，並關注穩健的理財產品。建議你學習基本的投資知識，在保持穩健的同時適度探索多元的投資機會。'
      },
      other: {
        personality: '勾陳型人格的你，擁有獨特的系統思維與穩定建構能力。你擅長在複雜的環境中建立秩序，在多元的需求間找到平衡。你的內心有一座包容而堅固的堡壘，為不同的群體提供支持與穩定。你可能不追求 spotlight，但你的存在是系統運轉的關鍵。對你而言，生活的美好在於建構包容、有序且可持續的環境。',
        strengths: '你最大的優勢在於「系統建構能力」與「多元協調力」。你能夠理解複雜系統的運作，並在多元需求間建立平衡。在團隊中，你是系統的架構師，能夠在變動中維持結構，在多元中建立和諧。你的系統思維與協調能力，是組織穩定運轉的重要保障。',
        career: '你的天賦在於所有需要系統思維與協調能力的領域。系統分析、專案管理、組織發展、多元文化協調等行業都非常適合你。你需要一個能夠讓你發揮建構能力、促進系統和諧的工作環境。你的價值在於為組織建立可持續的運作模式，並確保多元需求的平衡。',
        relationships: '在感情中，你追求的是深度的理解與穩定的支持。你重視關係中的平等與尊重，渴望建立基於相互理解與支持的親密連結。對你而言，最美好的關係是兩個獨立個體在相互尊重基础上的共同成長。你需要一個能夠欣賞你系統思維、並願意與你共同建構包容性關係的伴侶。',
        growth: '你的成長課題是「平衡結構與流動」。因為你擅長建立秩序與結構，有時可能會過度追求控制。學習在維持結構的同時，允許一定程度的流動與變化。培養對不確定性的容忍度，並在堅持原則的同時保持開放的態度，能夠幫助你更好地適應變動的環境。',
        money: '金錢卦象顯示，你的財富之道在於「系統性投資」與「長期建構」。你對系統運作的理解，能夠幫助你在投資上做出結構性的規劃。適合建立系統性的投資組合，並關注可持續的投資機會。建議你學習資產配置的知識，在保持穩健的同時建構多元的財富基礎。'
      }
    }
  }
  // 其他神獸的資料結構類似，因篇幅限制這裡只展示三種
};

// ========== 神獸超人顯示功能 (已加入性別判斷) ==========
function showSuperhero(beastType) {
    const gender = document.querySelector('input[name="gender"]:checked').value;
    const beastData = superheroData[beastType];
    
    if (beastData) {
        const genderData = beastData[gender] || beastData.male; // 預設為男性資料
        const superheroDisplay = document.getElementById("superhero-display");
        const superheroName = document.getElementById("superhero-name");
        const superheroAbility = document.getElementById("superhero-ability");
        const superheroMission = document.getElementById("superhero-mission");
        const superheroLocal = document.getElementById("superhero-local");
        
        superheroName.textContent = `${genderData.name}`;
        superheroAbility.textContent = genderData.ability;
        superheroMission.textContent = genderData.mission;
        superheroLocal.textContent = `🏮 台灣在地版：${genderData.localName} - ${genderData.description}`;
        document.getElementById("superheroReport").style.display = "block";
    }
}

// ========== AI分析填充功能 (已加入性別判斷) ==========
function fillAIAnalysis(beastType) {
    const gender = document.querySelector('input[name="gender"]:checked').value;
    const beastData = superheroData[beastType];
    
    if (beastData && beastData.analysis) {
        const genderAnalysis = beastData.analysis[gender] || beastData.analysis.male; // 預設為男性分析
        
        // 確保元素存在後再設置內容
        const personalityEl = document.getElementById("ai-personality");
        const strengthsEl = document.getElementById("ai-strengths");
        const careerEl = document.getElementById("ai-career");
        const relationshipsEl = document.getElementById("ai-relationships");
        const growthEl = document.getElementById("ai-growth");
        const moneyEl = document.getElementById("ai-money");
        
        if (personalityEl) personalityEl.textContent = genderAnalysis.personality;
        if (strengthsEl) strengthsEl.textContent = genderAnalysis.strengths;
        if (careerEl) careerEl.textContent = genderAnalysis.career;
        if (relationshipsEl) relationshipsEl.textContent = genderAnalysis.relationships;
        if (growthEl) growthEl.textContent = genderAnalysis.growth;
        if (moneyEl) moneyEl.textContent = genderAnalysis.money;
        
        console.log("AI分析內容已填充:", beastType, gender);
    } else {
        console.error("找不到對應的分析資料:", beastType, gender);
    }
}

// ========== 模擬進度條動畫 ==========
function simulateProgress(){
    const progressBar = document.getElementById("progress-bar");
    const loadingStep = document.getElementById("loading-step");
    const steps = [
        {percent: 20, text: "分析人格特質..."},
        {percent: 40, text: "解析能量分布..."},
        {percent: 60, text: "生成發展建議..."},
        {percent: 80, text: "計算五行金錢卦..."},
        {percent: 95, text: "最終整合報告..."},
        {percent: 100, text: "分析完成！"}
    ];
    let currentStep = 0;
    
    const interval = setInterval(() => {
        if (currentStep < steps.length) {
            progressBar.style.width = steps[currentStep].percent + "%";
            loadingStep.textContent = steps[currentStep].text;
            currentStep++;
        } else {
            clearInterval(interval);
        }
    }, 800);
}

// ========== 解析AI回應 (修復版本) ==========
function parseAIResponse(response, beastType) {
    const loadingEl = document.getElementById("ai-loading");
    const contentEl = document.getElementById("ai-analysis-content");
    
    if (loadingEl) loadingEl.style.display = "none";
    if (contentEl) contentEl.style.display = "block";
    
    try {
        // 如果AI回應有特定格式，嘗試解析
        if (response && response.includes("🎭") && response.includes("⚡") && response.includes("💰")) {
            const personalityMatch = response.match(/🎭[^⚡]+/);
            const strengthsMatch = response.match(/⚡[^📈]+/);
            const growthMatch = response.match(/📈[^💰]+/);
            const moneyMatch = response.match(/💰.+/);
            
            if (personalityMatch) {
                document.getElementById("ai-personality").textContent = personalityMatch[0].replace("🎭", "").trim();
            }
            if (strengthsMatch) {
                document.getElementById("ai-strengths").textContent = strengthsMatch[0].replace("⚡", "").trim();
            }
            if (moneyMatch) {
                document.getElementById("ai-money").textContent = moneyMatch[0].replace("💰", "").trim();
            }
            if (growthMatch) {
                const growthText = growthMatch[0].replace("📈", "").trim();
                document.getElementById("ai-career").textContent = growthText;
                document.getElementById("ai-relationships").textContent = growthText;
                document.getElementById("ai-growth").textContent = growthText;
            }
        } else {
            // 如果AI回應不符合預期格式，使用本地分析資料
            console.log("使用本地分析資料");
            fillAIAnalysis(beastType);
        }
    } catch (error) {
        console.error("AI回應解析失敗:", error);
        // 解析失敗時使用本地分析資料
        fillAIAnalysis(beastType);
    }
}

// ========== 測驗題庫 ==========
const BANK = [
    {t: "我常有突如其來的靈感並想立即嘗試。", b: "青龍"},
    {t: "我喜歡打破常規尋找新方法。", b: "青龍"},
    {t: "遇阻力時我會靈活轉向。", b: "青龍"},
    {t: "我富想像力，喜歡創新思考。", b: "青龍"},
    {t: "我熱愛探索未知事物。", b: "青龍"},
    {t: "我喜歡在人群中表達自己。", b: "朱雀"},
    {t: "我用情緒帶動他人。", b: "朱雀"},
    {t: "別人的反應會影響我。", b: "朱雀"},
    {t: "我擅長說服與演說。", b: "朱雀"},
    {t: "我重視被傾聽與關注。", b: "朱雀"},
    {t: "我喜歡按計畫行事。", b: "勾陳"},
    {t: "我重視安全感與穩定。", b: "勾陳"},
    {t: "我責任感強。", b: "勾陳"},
    {t: "我傾向維持現狀。", b: "勾陳"},
    {t: "我注重細節與程序。", b: "勾陳"},
    {t: "我對他人情緒很敏感。", b: "螣蛇"},
    {t: "我擅長觀察與傾聽。", b: "螣蛇"},
    {t: "我常思考背後的動機。", b: "螣蛇"},
    {t: "我思考事情會考量時機與人心。", b: "螣蛇"},
    {t: "我善於協調不同觀點。", b: "螣蛇"},
    {t: "我講求效率與結果。", b: "白虎"},
    {t: "我會主動做決策。", b: "白虎"},
    {t: "我以數據與成果為導向。", b: "白虎"},
    {t: "我願意承擔壓力以完成任務。", b: "白虎"},
    {t: "我偏好明確的規範與標準。", b: "白虎"},
    {t: "我喜歡獨自思考。", b: "玄武"},
    {t: "我傾向謹慎評估後行動。", b: "玄武"},
    {t: "我擅長規劃長遠目標。", b: "玄武"},
    {t: "我重視邏輯與分析。", b: "玄武"},
    {t: "我習慣冷靜看待問題。", b: "玄武"}
];

// 初始化測驗題目
BANK.sort(() => 0.5 - Math.random());
const qWrap = document.getElementById("qWrap");
BANK.forEach((q, i) => {
    qWrap.innerHTML += `<li><p>${i+1}. ${q.t}</p><input type='range' min='1' max='5' value='3' id='q${i}' class='w-full slider'></li>`;
});
qWrap.innerHTML += '<div id="progress" class="text-right text-sm">0/30</div>';

// 更新進度顯示
document.querySelectorAll('input[type="range"]').forEach(slider => {
    slider.onchange = () => {
        const answered = Array.from(document.querySelectorAll('input[type="range"]')).filter(s => s.value !== "3").length;
        document.getElementById("progress").textContent = `${answered}/30`;
    };
});

// ========== 神獸SVG圖標 ==========
function beastSVG(beast) {
    const color = "#B6822B";
    const fill = "none";
    const path = d => `<path d='${d}' fill='${fill}' stroke='${color}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>`;
    const wrap = content => `<svg viewBox='0 0 100 100' class='w-full h-auto' xmlns='http://www.w3.org/2000/svg'>
    <defs><radialGradient id='g' cx='50%' cy='50%' r='60%'>
      <stop offset='0%' stop-color='rgba(182,130,43,0.25)'/><stop offset='100%' stop-color='rgba(182,130,43,0)'/>
    </radialGradient></defs><rect width='100' height='100' fill='url(#g)'/>${content}</svg>`;
    
    switch(beast) {
        case "青龍": return wrap(
            path("M15 60 C25 40, 45 35, 55 45 C65 55, 75 35, 85 45 M45 45 q5 -12 16 -10 m-6 6 l6 4 m-36 20 q10 -6 18 2 m12 -2 q8 -6 18 2") +
            path("M30 70 q10 8 20 0 q10 -8 20 0")
        );
        case "朱雀": return wrap(
            path("M20 60 q15 -30 30 -30 q15 0 30 30 M50 30 l0 12 M35 55 q15 -8 30 0 M25 62 q10 8 25 8 q15 0 25 -8")
        );
        case "勾陳": return wrap(
            path("M20 70 h60 v-20 h-60 v20 z M30 50 v-10 h40 v10 M35 65 h10 M55 65 h10")
        );
        case "螣蛇": return wrap(
            path("M20 70 q20 -30 40 -10 q10 8 20 -2 q-10 20 -30 10 q-10 -6 -30 2 M60 48 q6 -6 12 0")
        );
        case "白虎": return wrap(
            path("M20 65 q15 -20 30 -20 q15 0 30 20 M30 60 h40 M35 70 h30 M38 52 l4 6 M58 52 l-4 6")
        );
        case "玄武": return wrap(
            path("M30 65 q20 15 40 0 q5 -12 -15 -22 q-20 10 -25 22 M55 50 q10 -8 20 2 M25 55 q-8 -6 -10 6")
        );
        default: return wrap("");
    }
}

// ========== 生成建議 ==========
function generateAdvice(mainBeast, secondaryBeast, scores, variant) {
    const adviceBank = {
        青龍: {
            職場: ["創新領頭，勇於嘗試新方法","帶領團隊突破傳統框架","開拓新市場或業務領域","將創意轉化為實際行動"],
            感情: ["保持關係中的新鮮感","共同探索新體驗","開放溝通創新想法","平衡冒險與穩定需求"],
            養生: ["戶外運動釋放能量","嘗試新的運動方式","保持生活多樣性","適當冒險挑戰自我"]
        },
        朱雀: {
            職場: ["發揮表達與溝通優勢","激勵團隊士氣","建立廣泛人際網絡","展現熱情與感染力"],
            感情: ["真誠表達情感需求","創造浪漫驚喜時刻","保持關係中的熱情","適度分享內心感受"],
            養生: ["藝術創作抒發情感","社交活動保持活力","表達性運動如舞蹈","注意情緒波動管理"]
        },
        勾陳: {
            職場: ["建立穩定工作流程","確保任務按時完成","注重細節與品質","提供可靠支持"],
            感情: ["建立信任與安全感","保持承諾與一致性","穩定表達關心","營造溫馨家庭氛圍"],
            養生: ["規律作息保持平衡","均衡飲食與運動","建立健康生活習慣","注重實際養生方法"]
        },
        螣蛇: {
            職場: ["發揮洞察與協調能力","理解團隊成員需求","妥善處理人際關係","把握時機採取行動"],
            感情: ["深入理解伴侶感受","敏感體貼對方需求","建立深度情感連結","適時表達支持"],
            養生: ["冥想與內省練習","情緒管理與釋放","溫和調理身心","注重心理平衡"]
        },
        白虎: {
            職場: ["果斷決策追求效率","設定明確目標","承擔領導責任","注重成果與績效"],
            感情: ["直接表達愛與承諾","保護與支持伴侶","明確關係界線","展現堅定與忠誠"],
            養生: ["高強度運動釋壓","挑戰體能極限","培養紀律性","注意壓力管理"]
        },
        玄武: {
            職場: ["策略規劃長遠發展","深入分析問題本質","獨立思考與判斷","保持理性與客觀"],
            感情: ["深度交流思想","理性分析關係","保持個人空間","建立智慧連結"],
            養生: ["靜坐與閱讀","深度思考與反思","獨立運動如游泳","注重精神養生"]
        }
    };
    
    const level = score => score >= 20 ? 0 : score >= 15 ? 1 : score >= 10 ? 2 : 3;
    const mainScore = scores[mainBeast];
    const secondaryScore = secondaryBeast ? scores[secondaryBeast] : 0;
    const mainLevel = level(mainScore);
    const secondaryLevel = level(secondaryScore);
    
    const pickAdvice = (category) => {
        const mainAdvice = adviceBank[mainBeast][category];
        const secondaryAdvice = secondaryBeast ? adviceBank[secondaryBeast][category] : [];
        let advice = [];
        
        // 主型建議
        if (mainAdvice && mainAdvice[mainLevel]) {
            advice.push(mainAdvice[mainLevel] + "。");
        }
        
        // 次型建議（如果次型分數夠高）
        if (secondaryBeast && secondaryScore >= 10 && secondaryAdvice && secondaryAdvice[secondaryLevel]) {
            advice.push(secondaryAdvice[secondaryLevel] + "。");
        }
        
        // 如果建議太少，隨機補充
        while (advice.length < 2) {
            const randomIndex = Math.floor(Math.random() * mainAdvice.length);
            if (!advice.includes(mainAdvice[randomIndex] + "。")) {
                advice.push(mainAdvice[randomIndex] + "。");
            }
        }
        
        return advice;
    };
    
    return {
        職場: pickAdvice("職場"),
        感情: pickAdvice("感情"),
        養生: pickAdvice("養生")
    };
}

// ========== 總結測驗結果 ==========
function summarize(scores) {
    const entries = Object.entries(scores).sort((a, b) => b[1] - a[1]);
    const top = entries[0];
    const secondary = entries[1];
    const dual = top[1] - secondary[1] <= 2 ? [top[0], secondary[0]] : null;
    
    const total = Object.values(scores).reduce((sum, score) => sum + score, 0);
    const variantIndex = total % 12;
    const variants = ["子","丑","寅","卯","辰","巳","午","未","申","酉","戌","亥"];
    
    return {
        top: top[0],
        dual: dual,
        ranking: entries,
        variant: variants[variantIndex],
        total: total,
        scores: scores
    };
}

let radarChart = null;

// ========== 渲染雷達圖 ==========
function renderRadar(scores) {
    const canvas = document.getElementById("radar");
    if (radarChart) {
        radarChart.destroy();
    }
    
    radarChart = new Chart(canvas, {
        type: "radar",
        data: {
            labels: Object.keys(scores),
            datasets: [{
                label: "六獸能量",
                data: Object.values(scores),
                backgroundColor: "rgba(182,130,43,0.15)",
                borderColor: "#b6822b"
            }]
        },
        options: {
            scales: {
                r: {
                    suggestedMin: 0,
                    suggestedMax: 25,
                    ticks: {
                        stepSize: 5
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            },
            maintainAspectRatio: true
        }
    });
}

// ========== 渲染報告 ==========
function renderReport(summary, scores) {
    document.getElementById("beastSVG").innerHTML = beastSVG(summary.top);
    
    const typeName = `${summary.top}${summary.variant}型`;
    document.getElementById("mainBeastTitle").textContent = summary.dual ? 
        `雙獸${summary.variant}型：${summary.top} × ${summary.dual[1]}` : 
        `主${summary.variant}型：${summary.top}`;
    
    document.getElementById("dualHint").textContent = summary.dual ? 
        `第二主導能量：${summary.dual[1]}` : "";
    
    document.getElementById("mainBeastSummary").textContent = 
        `你的主型為 ${typeName}，融合${summary.top}能量與${summary.variant}地支特質。`;
    
    const advice = generateAdvice(summary.top, summary.dual ? summary.dual[1] : null, scores, summary.variant);
    
    const adviceHTML = (title, items) => 
        `<div class='border rounded p-2'><b>${title}</b><ul class='list-disc pl-5'>${items.map(item => `<li>${item}</li>`).join("")}</ul></div>`;
    
    document.getElementById("adviceCols").innerHTML = 
        adviceHTML("職場建議", advice.職場) +
        adviceHTML("感情建議", advice.感情) +
        adviceHTML("養生建議", advice.養生);
}

let currentBeastType = "";

// ========== 表單提交處理 ==========
document.getElementById("form").addEventListener("submit", function(e) {
    e.preventDefault();
    
    // 獲取性別選擇
    const gender = document.querySelector('input[name="gender"]:checked').value;
    
    const scores = {青龍:0, 朱雀:0, 勾陳:0, 螣蛇:0, 白虎:0, 玄武:0};
    
    BANK.forEach((q, i) => {
        scores[q.b] += parseInt(document.getElementById(`q${i}`).value);
    });
    
    const summary = summarize(scores);
    currentBeastType = summary.top;
    
    renderRadar(scores);
    renderReport(summary, scores);
    
    // 儲存測驗結果（包含性別）
    localStorage.setItem("shen-shou-v7", JSON.stringify({
        scores: scores,
        summary: summary,
        gender: gender
    }));
    
    document.getElementById("result").style.display = "grid";
    document.getElementById("aiReport").style.display = "block";
    
    showSuperhero(summary.top);
});

// ========== 全部填3按鈕 ==========
document.getElementById("btnFillMid").onclick = function() {
    document.querySelectorAll(".slider").forEach(slider => {
        slider.value = 3;
    });
};

// ========== 分享結果圖片 ==========
document.getElementById("btnShare").addEventListener("click", function() {
    html2canvas(document.getElementById("result")).then(canvas => {
        const link = document.createElement("a");
        link.download = "shenshou-result.png";
        link.href = canvas.toDataURL();
        link.click();
    });
});

// ========== AI分析按鈕 (修復版本) ==========
document.getElementById("btnAI").addEventListener("click", async function() {
    const saved = JSON.parse(localStorage.getItem("shen-shou-v7") || "null");
    if (!saved) {
        alert("⚠️請先完成測驗。");
        return;
    }
    
    // 顯示載入狀態
    const loadingEl = document.getElementById("ai-loading");
    const contentEl = document.getElementById("ai-analysis-content");
    const btnAI = document.getElementById("btnAI");
    const btnRetry = document.getElementById("btnRetry");
    
    if (loadingEl) loadingEl.style.display = "block";
    if (contentEl) contentEl.style.display = "none";
    if (btnRetry) btnRetry.style.display = "none";
    if (btnAI) btnAI.disabled = true;
    
    // 開始進度條動畫
    simulateProgress();
    
    try {
        // 嘗試呼叫AI API
        const response = await fetch("/api/ai", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(saved)
        });
        
        if (!response.ok) {
            throw new Error(await response.text());
        }
        
        const data = await response.json();
        parseAIResponse(data.text.trim(), currentBeastType);
        
    } catch (error) {
        console.log("AI請求失敗，使用本地分析資料", error);
        // 使用本地分析資料作為備用
        fillAIAnalysis(currentBeastType);
        
        // 隱藏載入狀態，顯示內容
        if (loadingEl) loadingEl.style.display = "none";
        if (contentEl) contentEl.style.display = "block";
    } finally {
        // 恢復按鈕狀態
        if (loadingEl) loadingEl.style.display = "none";
        if (contentEl) contentEl.style.display = "block";
        if (btnRetry) btnRetry.style.display = "inline-block";
        if (btnAI) btnAI.disabled = false;
    }
});

// ========== 重新分析按鈕 ==========
document.getElementById("btnRetry").addEventListener("click", function() {
    document.getElementById("btnAI").click();
});
</script>
</body>
</html>
