<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼ æ¸¬é©—ï¼‹AIæ™ºèƒ½åˆ†æ</title>
  <meta name="description" content="å…­ç¸äººæ ¼AIåˆ†æï½œé‡‘éŒ¢å¦äº”è¡Œæ•´åˆï½œå³æ™‚é›·é”åœ–ï¼‹æ™ºèƒ½å ±å‘Š" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root { 
      --brand: #b6822b;
      --brand-light: #d4a862;
      --brand-dark: #8a6521;
    }
    body { 
      background: radial-gradient(circle at top left, #fffaf4, #f6f3ea);
      min-height: 100vh;
    }
    .brand { color: var(--brand); }
    .brand-gradient { 
      background: linear-gradient(135deg, var(--brand), var(--brand-light));
    }
    .card { 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 16px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    .slider { 
      accent-color: var(--brand);
      height: 6px;
      border-radius: 3px;
    }
    .slider::-webkit-slider-thumb {
      appearance: none;
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: var(--brand);
      cursor: pointer;
      border: 2px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    @media print { 
      .no-print { display: none !important; } 
    }
    .question-item {
      padding: 1rem;
      margin: 0.5rem 0;
      border-left: 4px solid transparent;
      transition: all 0.3s ease;
    }
    .question-item:hover {
      border-left-color: var(--brand);
      background: #faf7f0;
    }
    .loading-dots:after {
      content: '';
      animation: dots 1.5s steps(5, end) infinite;
    }
    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
  </style>
</head>
<body class="text-slate-800">

<main class="max-w-5xl mx-auto p-4 sm:p-6">
  <header class="mb-8 text-center">
    <div class="flex justify-center items-center gap-4 mb-4">
      <img src="img/logo.png" class="h-16 w-auto rounded-full shadow-lg" alt="ä»™äººæŒ‡è·¯ Logo" />
      <div>
        <h1 class="text-3xl sm:text-4xl font-bold brand">ç¥ç¸ä¸ƒåäºŒå‹äººæ ¼</h1>
        <p class="text-lg text-slate-600 mt-2">å…­ç¸é›·é”åœ–ãƒ»ä¸»ç¥ç¸è§£æãƒ»ä¸‰æ¬„å»ºè­°ãƒ»AIåˆ†æå ±å‘Š</p>
      </div>
    </div>
    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 max-w-2xl mx-auto">
      <p class="text-sm text-amber-800">
        ğŸ¯ æœ¬æ¸¬é©—èåˆæ˜“ç¶“äº”è¡Œã€å…­ç¸è±¡å¾µèˆ‡ç¾ä»£å¿ƒç†å­¸ï¼Œæä¾›å…¨æ–¹ä½äººæ ¼åˆ†æ
      </p>
    </div>
  </header>

  <!-- å•å·éƒ¨åˆ† -->
  <section class="card p-6 mb-8">
    <div class="flex items-center gap-3 mb-6">
      <div class="brand-gradient w-8 h-8 rounded-full flex items-center justify-center text-white font-bold">1</div>
      <h2 class="text-xl font-bold">ğŸ“‹ è«‹å›ç­”ä¸‹åˆ—30é¡Œäººæ ¼æ¸¬é©—</h2>
    </div>
    
    <div class="bg-slate-50 rounded-lg p-4 mb-4">
      <div class="flex justify-between text-sm text-slate-600 mb-2">
        <span>1ï¼å®Œå…¨ä¸åŒæ„</span>
        <span>3ï¼æ™®é€š</span>
        <span>5ï¼éå¸¸åŒæ„</span>
      </div>
    </div>

    <form id="form">
      <ol id="qWrap" class="space-y-4"></ol>
      
      <div class="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
        <button type="submit" class="brand-gradient text-white px-8 py-3 rounded-lg font-semibold shadow-lg hover:shadow-xl transition-all">
          ğŸš€ ç”Ÿæˆç¥ç¸äººæ ¼åˆ†æå ±å‘Š
        </button>
        <button type="button" id="btnFillMid" class="border border-slate-300 px-6 py-3 rounded-lg font-medium hover:bg-slate-50 transition-colors">
          âš–ï¸ å…¨éƒ¨è¨­ç‚ºä¸­é–“å€¼
        </button>
      </div>
    </form>
  </section>

  <!-- çµæœé¡¯ç¤ºå€åŸŸ -->
  <section id="result" class="hidden">
    <div class="flex items-center gap-3 mb-6">
      <div class="brand-gradient w-8 h-8 rounded-full flex items-center justify-center text-white font-bold">2</div>
      <h2 class="text-xl font-bold">âœ¨ æ‚¨çš„ç¥ç¸äººæ ¼åˆ†æçµæœ</h2>
    </div>

    <div class="grid lg:grid-cols-2 gap-6 mb-8">
      <!-- é›·é”åœ– -->
      <div class="card p-6">
        <h3 class="font-bold mb-4 text-lg flex items-center gap-2">
          <span>ğŸ“Š</span> å…­ç¸èƒ½é‡é›·é”åœ–
        </h3>
        <div class="relative">
          <canvas id="radar" height="300"></canvas>
        </div>
      </div>

      <!-- ä¸»ç¥ç¸åˆ†æ -->
      <div class="card p-6" id="resultCard">
        <h3 class="font-bold mb-4 text-lg flex items-center gap-2">
          <span>ğŸ‰</span> ä¸»ç¥ç¸èˆ‡ç‰¹è³ªåˆ†æ
        </h3>
        
        <div class="grid grid-cols-3 gap-4 items-start mb-4">
          <div id="beastSVG" class="w-full aspect-square bg-amber-50 rounded-lg p-4"></div>
          <div class="col-span-2">
            <div id="mainBeastTitle" class="font-bold text-xl brand mb-2"></div>
            <div id="dualHint" class="text-sm text-slate-600 mb-3 p-2 bg-slate-50 rounded"></div>
            <div id="mainBeastSummary" class="text-sm leading-relaxed"></div>
          </div>
        </div>

        <hr class="my-4" />
        
        <h4 class="font-semibold mb-3">ğŸ’¡ äººç”Ÿå»ºè­°</h4>
        <div id="adviceCols" class="grid md:grid-cols-3 gap-4 text-sm"></div>
      </div>
    </div>

    <!-- AIæ™ºèƒ½åˆ†æ -->
    <div class="card p-6 mt-6" id="aiReport">
      <div class="flex items-center gap-3 mb-4">
        <div class="brand-gradient w-8 h-8 rounded-full flex items-center justify-center text-white font-bold">3</div>
        <h3 class="text-xl font-bold">ğŸ¤– AI æ™ºèƒ½å€‹äººåŒ–åˆ†æå ±å‘Š</h3>
      </div>
      
      <p class="text-sm text-slate-600 mb-4">
        ä»¥ä¸‹å…§å®¹ç”±ä»™äººæŒ‡è·¯AIç³»çµ±ç”Ÿæˆï¼Œèåˆæ˜“ç¶“äº”è¡Œã€å…­ç¸è±¡å¾µèˆ‡ç¾ä»£å¿ƒç†å­¸è¦–è§’ï¼Œç‚ºæ‚¨æä¾›æ·±åº¦å€‹äººåŒ–åˆ†æã€‚
      </p>
      
      <button id="btnAI" class="no-print px-6 py-3 border-2 border-amber-500 text-amber-600 rounded-lg font-semibold hover:bg-amber-50 transition-colors flex items-center gap-2">
        <span>ğŸ”®</span> ç”Ÿæˆæ·±åº¦AIåˆ†æå ±å‘Š
      </button>
      
      <div id="aiOut" class="mt-6 p-4 bg-slate-50 rounded-lg border border-slate-200 min-h-[200px]">
        <p class="text-slate-500 text-center py-8">é»æ“Šä¸Šæ–¹æŒ‰éˆ•ç”ŸæˆAIæ·±åº¦åˆ†æå ±å‘Š</p>
      </div>
    </div>
  </section>

  <footer class="text-center text-sm text-slate-500 mt-12 pt-6 border-t border-slate-200">
    <p>Â© 2025 ä»™äººæŒ‡è·¯å åœç ”ç©¶å­¸æœƒï½œæ¸¬é©—åƒ…ä¾›è¦ºå¯Ÿèˆ‡æ•™å­¸ç”¨é€”ï¼Œéå°ˆæ¥­å¿ƒç†è¨ºæ–·</p>
  </footer>
</main>

<script>
// ========== é¡Œåº« ==========
const BANK = [
  // ä¿æŒåŸæœ‰çš„é¡Œåº«æ•¸æ“šä¸è®Š
  {t:"æˆ‘å¸¸æœ‰çªå¦‚å…¶ä¾†çš„éˆæ„Ÿä¸¦æƒ³ç«‹å³å˜—è©¦ã€‚",b:"é’é¾"},
  {t:"æˆ‘å–œæ­¡æ‰“ç ´å¸¸è¦å°‹æ‰¾æ–°æ–¹æ³•ã€‚",b:"é’é¾"},
  {t:"é‡é˜»åŠ›æ™‚æˆ‘æœƒéˆæ´»è½‰å‘ã€‚",b:"é’é¾"},
  {t:"æˆ‘å¯Œæƒ³åƒåŠ›ï¼Œå–œæ­¡å‰µæ–°æ€è€ƒã€‚",b:"é’é¾"},
  {t:"æˆ‘ç†±æ„›æ¢ç´¢æœªçŸ¥äº‹ç‰©ã€‚",b:"é’é¾"},
  {t:"æˆ‘å–œæ­¡åœ¨äººç¾¤ä¸­è¡¨é”è‡ªå·±ã€‚",b:"æœ±é›€"},
  {t:"æˆ‘ç”¨æƒ…ç·’å¸¶å‹•ä»–äººã€‚",b:"æœ±é›€"},
  {t:"åˆ¥äººçš„åæ‡‰æœƒå½±éŸ¿æˆ‘ã€‚",b:"æœ±é›€"},
  {t:"æˆ‘æ“…é•·èªªæœèˆ‡æ¼”èªªã€‚",b:"æœ±é›€"},
  {t:"æˆ‘é‡è¦–è¢«å‚¾è½èˆ‡é—œæ³¨ã€‚",b:"æœ±é›€"},
  {t:"æˆ‘å–œæ­¡æŒ‰è¨ˆç•«è¡Œäº‹ã€‚",b:"å‹¾é™³"},
  {t:"æˆ‘é‡è¦–å®‰å…¨æ„Ÿèˆ‡ç©©å®šã€‚",b:"å‹¾é™³"},
  {t:"æˆ‘è²¬ä»»æ„Ÿå¼·ã€‚",b:"å‹¾é™³"},
  {t:"æˆ‘å‚¾å‘ç¶­æŒç¾ç‹€ã€‚",b:"å‹¾é™³"},
  {t:"æˆ‘æ³¨é‡ç´°ç¯€èˆ‡ç¨‹åºã€‚",b:"å‹¾é™³"},
  {t:"æˆ‘å°ä»–äººæƒ…ç·’å¾ˆæ•æ„Ÿã€‚",b:"è£è›‡"},
  {t:"æˆ‘æ“…é•·è§€å¯Ÿèˆ‡å‚¾è½ã€‚",b:"è£è›‡"},
  {t:"æˆ‘å¸¸æ€è€ƒèƒŒå¾Œçš„å‹•æ©Ÿã€‚",b:"è£è›‡"},
  {t:"æˆ‘æ€è€ƒäº‹æƒ…æœƒè€ƒé‡æ™‚æ©Ÿèˆ‡äººå¿ƒã€‚",b:"è£è›‡"},
  {t:"æˆ‘å–„æ–¼å”èª¿ä¸åŒè§€é»ã€‚",b:"è£è›‡"},
  {t:"æˆ‘è¬›æ±‚æ•ˆç‡èˆ‡çµæœã€‚",b:"ç™½è™"},
  {t:"æˆ‘æœƒä¸»å‹•åšæ±ºç­–ã€‚",b:"ç™½è™"},
  {t:"æˆ‘ä»¥æ•¸æ“šèˆ‡æˆæœç‚ºå°å‘ã€‚",b:"ç™½è™"},
  {t:"æˆ‘é¡˜æ„æ‰¿æ“”å£“åŠ›ä»¥å®Œæˆä»»å‹™ã€‚",b:"ç™½è™"},
  {t:"æˆ‘åå¥½æ˜ç¢ºçš„è¦ç¯„èˆ‡æ¨™æº–ã€‚",b:"ç™½è™"},
  {t:"æˆ‘å–œæ­¡ç¨è‡ªæ€è€ƒã€‚",b:"ç„æ­¦"},
  {t:"æˆ‘å‚¾å‘è¬¹æ…è©•ä¼°å¾Œè¡Œå‹•ã€‚",b:"ç„æ­¦"},
  {t:"æˆ‘æ“…é•·è¦åŠƒé•·é ç›®æ¨™ã€‚",b:"ç„æ­¦"},
  {t:"æˆ‘é‡è¦–é‚è¼¯èˆ‡åˆ†æã€‚",b:"ç„æ­¦"},
  {t:"æˆ‘ç¿’æ…£å†·éœçœ‹å¾…å•é¡Œã€‚",b:"ç„æ­¦"},
];

// åˆå§‹åŒ–é¡Œç›®
const qWrap = document.getElementById("qWrap");
BANK.forEach((q, i) => {
  qWrap.innerHTML += `
    <li class="question-item card">
      <p class="font-medium mb-3">${i + 1}. ${q.t}</p>
      <div class="flex items-center gap-4">
        <span class="text-sm text-slate-500">ä¸åŒæ„</span>
        <input type='range' min='1' max='5' value='3' id='q${i}' class='flex-1 slider'>
        <span class="text-sm text-slate-500">éå¸¸åŒæ„</span>
        <span class="w-8 text-center font-medium brand" id="valueq${i}">3</span>
      </div>
    </li>
  `;
});

// æ·»åŠ æ»‘æ¡¿æ•¸å€¼é¡¯ç¤º
document.querySelectorAll('.slider').forEach(slider => {
  const valueDisplay = document.getElementById(`value${slider.id}`);
  slider.addEventListener('input', () => {
    valueDisplay.textContent = slider.value;
  });
});

// ========== ç¥ç¸SVG (ä¿æŒä¸è®Š) ==========
function beastSVG(name) {
  // ä¿æŒåŸæœ‰çš„SVGä»£ç¢¼ä¸è®Š
  const stroke = '#B6822B', fill = 'none';
  const s = d => `<path d='${d}' fill='${fill}' stroke='${stroke}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>`;
  const base = d => `<svg viewBox='0 0 100 100' class='w-full h-auto' xmlns='http://www.w3.org/2000/svg'>
    <defs><radialGradient id='g' cx='50%' cy='50%' r='60%'>
      <stop offset='0%' stop-color='rgba(182,130,43,0.25)'/><stop offset='100%' stop-color='rgba(182,130,43,0)'/>
    </radialGradient></defs><rect width='100' height='100' fill='url(#g)'/>${d}</svg>`;
  
  switch (name) {
    case 'é’é¾': return base(s("M15 60 C25 40, 45 35, 55 45 C65 55, 75 35, 85 45 M45 45 q5 -12 16 -10 m-6 6 l6 4 m-36 20 q10 -6 18 2 m12 -2 q8 -6 18 2") + s("M30 70 q10 8 20 0 q10 -8 20 0"));
    case 'æœ±é›€': return base(s("M20 60 q15 -30 30 -30 q15 0 30 30 M50 30 l0 12 M35 55 q15 -8 30 0 M25 62 q10 8 25 8 q15 0 25 -8"));
    case 'å‹¾é™³': return base(s("M20 70 h60 v-20 h-60 v20 z M30 50 v-10 h40 v10 M35 65 h10 M55 65 h10"));
    case 'è£è›‡': return base(s("M20 70 q20 -30 40 -10 q10 8 20 -2 q-10 20 -30 10 q-10 -6 -30 2 M60 48 q6 -6 12 0"));
    case 'ç™½è™': return base(s("M20 65 q15 -20 30 -20 q15 0 30 20 M30 60 h40 M35 70 h30 M38 52 l4 6 M58 52 l-4 6"));
    case 'ç„æ­¦': return base(s("M30 65 q20 15 40 0 q5 -12 -15 -22 q-20 10 -25 22 M55 50 q10 -8 20 2 M25 55 q-8 -6 -10 6"));
    default: return base('');
  }
}

// ========== çµæœç”Ÿæˆ (æ”¹é€²ç‰ˆæœ¬) ==========
function summarize(scores) {
  const arr = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  const top = arr[0], second = arr[1];
  const dual = (top[1] - second[1] <= 2) ? [top[0], second[0]] : null;
  return { top: top[0], dual, ranking: arr };
}

let radarChart = null;
function renderRadar(scores) {
  const ctx = document.getElementById("radar");
  if (radarChart) radarChart.destroy();
  
  // æ”¹é€²é›·é”åœ–æ¨£å¼
  radarChart = new Chart(ctx, {
    type: "radar",
    data: {
      labels: Object.keys(scores),
      datasets: [{
        label: "å…­ç¸èƒ½é‡",
        data: Object.values(scores),
        backgroundColor: "rgba(182, 130, 43, 0.2)",
        borderColor: "#b6822b",
        borderWidth: 2,
        pointBackgroundColor: "#b6822b",
        pointBorderColor: "#fff",
        pointHoverBackgroundColor: "#fff",
        pointHoverBorderColor: "#b6822b"
      }]
    },
    options: {
      scales: {
        r: {
          suggestedMin: 0,
          suggestedMax: 25,
          ticks: {
            stepSize: 5,
            backdropColor: 'transparent'
          },
          grid: {
            color: 'rgba(0,0,0,0.1)'
          },
          angleLines: {
            color: 'rgba(0,0,0,0.1)'
          },
          pointLabels: {
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#4b5563'
          }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.8)',
          titleFont: { size: 12 },
          bodyFont: { size: 11 }
        }
      },
      maintainAspectRatio: false
    }
  });
}

function renderReport(summary, scores) {
  document.getElementById("beastSVG").innerHTML = beastSVG(summary.top);
  document.getElementById("mainBeastTitle").textContent = 
    summary.dual ? `é›™ç¸å‹ï¼š${summary.top} Ã— ${summary.dual[1]}` : `ä¸»ç¥ç¸ï¼š${summary.top}`;
  
  document.getElementById("dualHint").textContent = 
    summary.dual ? `ğŸŒŸ ç¬¬äºŒä¸»å°èƒ½é‡ï¼š${summary.dual[1]}ï¼ˆèƒ½é‡å¹³è¡¡å‹ï¼‰` : 'âœ¨ å–®ä¸€ä¸»å°ç‰¹è³ªæ˜é¡¯';
  
  document.getElementById("mainBeastSummary").textContent = 
    `ä½ çš„æ ¸å¿ƒäººæ ¼ç”± ${summary.top} ä¸»å°ï¼Œé€™åæ˜ äº†ä½ æœ€çªå‡ºçš„æ€§æ ¼ç‰¹è³ªå’Œè¡Œç‚ºæ¨¡å¼ã€‚`;

  // æ”¹é€²å»ºè­°æ¬„ä½
  const col = (t, a, icon) => `
    <div class="card p-4 h-full">
      <div class="flex items-center gap-2 mb-3">
        <span class="text-lg">${icon}</span>
        <b class="brand">${t}</b>
      </div>
      <ul class="space-y-2 text-sm">${a.map(x => `<li class="flex items-start gap-2"><span class="brand mt-1">â€¢</span><span>${x}</span></li>`).join('')}</ul>
    </div>`;
  
  const advice = {
    è·å ´: [
      "æ ¹æ“šä½ çš„ç¥ç¸ç‰¹è³ªé¸æ“‡åˆé©çš„å·¥ä½œç’°å¢ƒ",
      "ç™¼æ®ä¸»ç¥ç¸å„ªå‹¢ï¼Œå¹³è¡¡æ¬¡è¦èƒ½é‡",
      "å»ºç«‹é©åˆè‡ªå·±çš„å·¥ä½œç¯€å¥å’Œæ¨¡å¼"
    ],
    æ„Ÿæƒ…: [
      "ç†è§£è‡ªå·±çš„æƒ…æ„Ÿè¡¨é”æ–¹å¼",
      "å°‹æ‰¾èƒ½é‡äº’è£œçš„ä¼´ä¾¶é—œä¿‚",
      "ä¿æŒæƒ…æ„Ÿæºé€šçš„å¹³è¡¡"
    ],
    é¤Šç”Ÿ: [
      "æ ¹æ“šèƒ½é‡ç‰¹è³ªé¸æ“‡é©åˆçš„é‹å‹•",
      "æ³¨æ„æƒ…ç·’å’Œå£“åŠ›çš„å¹³è¡¡èª¿ç¯€",
      "å»ºç«‹è¦å¾‹çš„ä½œæ¯å’Œé£²é£Ÿç¿’æ…£"
    ]
  };
  
  document.getElementById("adviceCols").innerHTML = 
    col("è·å ´å»ºè­°", advice.è·å ´, "ğŸ’¼") +
    col("æ„Ÿæƒ…å»ºè­°", advice.æ„Ÿæƒ…, "â¤ï¸") +
    col("é¤Šç”Ÿå»ºè­°", advice.é¤Šç”Ÿ, "ğŸŒ¿");
}

// è¡¨å–®æäº¤è™•ç†
document.getElementById("form").addEventListener("submit", e => {
  e.preventDefault();
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = 'â³ åˆ†æä¸­...';
  submitBtn.disabled = true;
  
  setTimeout(() => {
    const scores = { é’é¾: 0, æœ±é›€: 0, å‹¾é™³: 0, è£è›‡: 0, ç™½è™: 0, ç„æ­¦: 0 };
    BANK.forEach((q, i) => scores[q.b] += parseInt(document.getElementById(`q${i}`).value));
    
    const summary = summarize(scores);
    renderRadar(scores);
    renderReport(summary, scores);
    
    // é¡¯ç¤ºçµæœå€åŸŸ
    document.getElementById("result").classList.remove("hidden");
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å„²
    localStorage.setItem("shen-shou-v7", JSON.stringify({ scores, summary }));
    
    // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
    
    // æ»¾å‹•åˆ°çµæœå€åŸŸ
    document.getElementById("result").scrollIntoView({ behavior: 'smooth' });
  }, 1000);
});

// å…¨éƒ¨å¡«ä¸­é–“å€¼
document.getElementById("btnFillMid").onclick = () => {
  document.querySelectorAll(".slider").forEach(s => {
    s.value = 3;
    const valueDisplay = document.getElementById(`value${s.id}`);
    if (valueDisplay) valueDisplay.textContent = '3';
  });
};

// ========== AIæ™ºèƒ½åˆ†æ (æ”¹é€²ç‰ˆæœ¬) ==========
document.getElementById("btnAI").addEventListener("click", async () => {
  const saved = JSON.parse(localStorage.getItem("shen-shou-v7") || "null");
  const out = document.getElementById("aiOut");
  const btn = document.getElementById("btnAI");
  
  if (!saved) {
    out.innerHTML = '<p class="text-red-500">âš ï¸ è«‹å…ˆå®Œæˆæ¸¬é©—ä»¥ç”Ÿæˆåˆ†æå ±å‘Š</p>';
    return;
  }
  
  // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
  out.innerHTML = '<div class="text-center py-8"><div class="loading-dots text-amber-600 text-lg">ğŸª¶ AIæ­£åœ¨æ·±åº¦åˆ†ææ‚¨çš„ç¥ç¸äººæ ¼ç‰¹è³ª</div></div>';
  btn.disabled = true;
  btn.innerHTML = 'â³ åˆ†æç”Ÿæˆä¸­...';
  
  try {
    const resp = await fetch("/api/ai", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(saved)
    });
    
    if (!resp.ok) throw new Error(await resp.text());
    
    const data = await resp.json();
    out.innerHTML = `<div class="prose prose-sm max-w-none">${formatAIText(data.text)}</div>`;
    
  } catch (err) {
    console.error('AIåˆ†æéŒ¯èª¤:', err);
    out.innerHTML = `<p class="text-red-500">âŒ åˆ†æå¤±æ•—ï¼š${err.message}</p>`;
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'ğŸ”® ç”Ÿæˆæ·±åº¦AIåˆ†æå ±å‘Š';
  }
});

// æ ¼å¼åŒ–AIè¿”å›çš„æ–‡æœ¬
function formatAIText(text) {
  return text
    .split('\n')
    .map(line => {
      if (line.match(/^ã€.*ã€‘$/)) {
        return `<h4 class="font-bold text-amber-700 mt-4 mb-2">${line}</h4>`;
      } else if (line.match(/^[0-9]+\./)) {
        return `<div class="ml-4 my-1">${line}</div>`;
      } else if (line.trim() === '') {
        return '<br>';
      } else {
        return `<p class="my-2 leading-relaxed">${line}</p>`;
      }
    })
    .join('');
}
</script>
</body>
</html>
