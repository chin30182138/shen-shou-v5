<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>神獸七十二型人格 測驗＋AI智能分析</title>
  <meta name="description" content="六獸人格AI分析｜金錢卦五行整合｜即時雷達圖＋智能報告" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root { --brand: #b6822b; }
    body { background: radial-gradient(circle at top left, #fffaf4, #f6f3ea); }
    .brand { color: var(--brand); }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .slider { accent-color: var(--brand); }
    .spinner { animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    @media print { .no-print { display: none !important; } }
  </style>
</head>
<body class="text-slate-800">
<main class="max-w-5xl mx-auto p-4 sm:p-6">
  <header class="mb-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <img src="img/logo.png" class="h-10 w-auto rounded" alt="仙人指路 Logo" />
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold brand">神獸七十二型人格 測驗＋AI智能分析</h1>
        <p class="text-sm text-slate-600">六獸雷達圖・主型解析・三欄建議・AI分析報告</p>
      </div>
    </div>
  </header>

  <!-- 問卷 -->
  <form id="form" class="card p-4 mb-4">
    <h2 class="font-bold mb-3">📋 請回答下列30題（1＝不同意，5＝非常同意）</h2>
    <ol id="qWrap" class="space-y-3"></ol>
    <div class="mt-4 flex gap-3">
      <button type="submit" class="bg-amber-600 text-white px-5 py-2 rounded">送出測驗</button>
      <button type="button" id="btnFillMid" class="border px-3 py-2 rounded no-print">全部填3</button>
      <button type="button" id="btnClear" class="border px-3 py-2 rounded no-print text-red-600">重新開始</button>
    </div>
  </form>

  <!-- 結果 - 初始隱藏 -->
  <section id="result" class="grid lg:grid-cols-2 gap-4" style="display: none;">
    <div class="card p-4">
      <h2 class="font-bold mb-2">六獸能量雷達圖</h2>
      <canvas id="radar"></canvas>
    </div>
    <div class="card p-4" id="resultCard">
      <h2 class="font-bold mb-2">主型與三欄建議</h2>
      <div class="grid grid-cols-3 gap-3 items-start">
        <div id="beastSVG" class="w-full aspect-square"></div>
        <div class="col-span-2">
          <div id="mainBeastTitle" class="font-bold brand"></div>
          <div id="dualHint" class="text-sm text-slate-600"></div>
          <div id="mainBeastSummary" class="mt-1 text-sm"></div>
        </div>
      </div>
      <hr class="my-2" />
      <div id="adviceCols" class="grid md:grid-cols-3 gap-2 text-sm"></div>
      <button id="btnShare" class="mt-4 px-4 py-2 border rounded no-print">分享結果圖片</button>
    </div>
  </section>

  <!-- AI 智能分析 - 初始隱藏 -->
  <section class="card p-4 mt-4" id="aiReport" style="display: none;">
    <h2 class="font-bold mb-2">🤖 AI 智能個人化分析報告</h2>
    <p class="text-sm text-slate-600 mb-3">以下內容由仙人指路AI系統生成，融合金錢卦、五行、地支與心理視角。</p>
    <div class="flex gap-2 flex-wrap">
      <button id="btnAI" class="px-4 py-2 border rounded no-print bg-blue-100">生成AI分析報告</button>
      <button id="btnMockAI" class="px-4 py-2 border rounded no-print bg-green-100">使用模擬分析</button>
      <button id="btnRetry" class="px-4 py-2 border rounded bg-gray-200 no-print" style="display:none;">重試AI分析</button>
    </div>
    <div id="aiStatus" class="text-sm text-blue-600 mt-2" style="display:none;"></div>
    <pre id="aiOut" class="mt-3 text-sm bg-slate-50 p-3 rounded-lg whitespace-pre-wrap leading-relaxed"></pre>
  </section>

  <footer class="text-center text-xs text-slate-500 mt-8">
    © 2025 仙人指路占卜研究學會｜測驗僅供覺察與教學用途
  </footer>
</main>

<script>
// ========== 題庫 ==========
const BANK = [
  {t:"我常有突如其來的靈感並想立即嘗試。",b:"青龍"},
  {t:"我喜歡打破常規尋找新方法。",b:"青龍"},
  {t:"遇阻力時我會靈活轉向。",b:"青龍"},
  {t:"我富想像力，喜歡創新思考。",b:"青龍"},
  {t:"我熱愛探索未知事物。",b:"青龍"},
  {t:"我喜歡在人群中表達自己。",b:"朱雀"},
  {t:"我用情緒帶動他人。",b:"朱雀"},
  {t:"別人的反應會影響我。",b:"朱雀"},
  {t:"我擅長說服與演說。",b:"朱雀"},
  {t:"我重視被傾聽與關注。",b:"朱雀"},
  {t:"我喜歡按計畫行事。",b:"勾陳"},
  {t:"我重視安全感與穩定。",b:"勾陳"},
  {t:"我責任感強。",b:"勾陳"},
  {t:"我傾向維持現狀。",b:"勾陳"},
  {t:"我注重細節與程序。",b:"勾陳"},
  {t:"我對他人情緒很敏感。",b:"螣蛇"},
  {t:"我擅長觀察與傾聽。",b:"螣蛇"},
  {t:"我常思考背後的動機。",b:"螣蛇"},
  {t:"我思考事情會考量時機與人心。",b:"螣蛇"},
  {t:"我善於協調不同觀點。",b:"螣蛇"},
  {t:"我講求效率與結果。",b:"白虎"},
  {t:"我會主動做決策。",b:"白虎"},
  {t:"我以數據與成果為導向。",b:"白虎"},
  {t:"我願意承擔壓力以完成任務。",b:"白虎"},
  {t:"我偏好明確的規範與標準。",b:"白虎"},
  {t:"我喜歡獨自思考。",b:"玄武"},
  {t:"我傾向謹慎評估後行動。",b:"玄武"},
  {t:"我擅長規劃長遠目標。",b:"玄武"},
  {t:"我重視邏輯與分析。",b:"玄武"},
  {t:"我習慣冷靜看待問題。",b:"玄武"},
];

// 初始化題目
function initializeQuestions() {
  // 隨機題目
  BANK.sort(() => Math.random() - 0.5);
  const qWrap = document.getElementById("qWrap");
  qWrap.innerHTML = '';
  
  BANK.forEach((q, i) => {
    qWrap.innerHTML += `<li><p>${i+1}. ${q.t}</p><input type='range' min='1' max='5' value='3' id='q${i}' class='w-full slider'></li>`;
  });

  // 進度條
  qWrap.innerHTML += `<div id="progress" class="text-right text-sm">0/30</div>`;
  document.querySelectorAll('input[type="range"]').forEach(s => {
    s.onchange = () => {
      const filled = Array.from(document.querySelectorAll('input[type="range"]')).filter(s => s.value !== '3').length;
      document.getElementById("progress").textContent = `${filled}/30`;
    };
  });
}

// ========== 神獸SVG ==========
function beastSVG(name) {
  const stroke = '#B6822B', fill = 'none';
  const s = d => `<path d='${d}' fill='${fill}' stroke='${stroke}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>`;
  const base = d => `<svg viewBox='0 0 100 100' class='w-full h-auto' xmlns='http://www.w3.org/2000/svg'>
    <defs><radialGradient id='g' cx='50%' cy='50%' r='60%'>
      <stop offset='0%' stop-color='rgba(182,130,43,0.25)'/><stop offset='100%' stop-color='rgba(182,130,43,0)'/>
    </radialGradient></defs><rect width='100' height='100' fill='url(#g)'/>${d}</svg>`;
  switch (name) {
    case '青龍': return base(s("M15 60 C25 40, 45 35, 55 45 C65 55, 75 35, 85 45 M45 45 q5 -12 16 -10 m-6 6 l6 4 m-36 20 q10 -6 18 2 m12 -2 q8 -6 18 2") + s("M30 70 q10 8 20 0 q10 -8 20 0"));
    case '朱雀': return base(s("M20 60 q15 -30 30 -30 q15 0 30 30 M50 30 l0 12 M35 55 q15 -8 30 0 M25 62 q10 8 25 8 q15 0 25 -8"));
    case '勾陳': return base(s("M20 70 h60 v-20 h-60 v20 z M30 50 v-10 h40 v10 M35 65 h10 M55 65 h10"));
    case '螣蛇': return base(s("M20 70 q20 -30 40 -10 q10 8 20 -2 q-10 20 -30 10 q-10 -6 -30 2 M60 48 q6 -6 12 0"));
    case '白虎': return base(s("M20 65 q15 -20 30 -20 q15 0 30 20 M30 60 h40 M35 70 h30 M38 52 l4 6 M58 52 l-4 6"));
    case '玄武': return base(s("M30 65 q20 15 40 0 q5 -12 -15 -22 q-20 10 -25 22 M55 50 q10 -8 20 2 M25 55 q-8 -6 -10 6"));
    default: return base('');
  }
}

// ========== 結果生成 ==========
function summarize(scores) {
  const arr = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  const top = arr[0], second = arr[1];
  const dual = (top[1] - second[1] <= 1) ? [top[0], second[0]] : null;
  const total = Object.values(scores).reduce((a, b) => a + b, 0);
  const variantIdx = total % 12;
  const variants = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
  const variant = variants[variantIdx];
  return { top: top[0], dual, ranking: arr, variant, total };
}

let radarChart = null;
function renderRadar(scores) {
  const ctx = document.getElementById("radar");
  if (radarChart) radarChart.destroy();
  radarChart = new Chart(ctx, {
    type: "radar",
    data: { labels: Object.keys(scores), datasets: [{ label: "六獸能量", data: Object.values(scores), backgroundColor: "rgba(182,130,43,0.15)", borderColor: "#b6822b" }] },
    options: { scales: { r: { suggestedMin: 0, suggestedMax: 25, ticks: { stepSize: 5 } } }, plugins: { legend: { display: false } } }
  });
}

function renderReport(summary, scores) {
  document.getElementById("beastSVG").innerHTML = beastSVG(summary.top);
  const mainType = `${summary.top}${summary.variant}型`;
  document.getElementById("mainBeastTitle").textContent = summary.dual ? `雙獸${summary.variant}型：${summary.top} × ${summary.dual[1]}` : `主${summary.variant}型：${summary.top}`;
  document.getElementById("dualHint").textContent = summary.dual ? `第二主導能量：${summary.dual[1]}` : '';
  document.getElementById("mainBeastSummary").textContent = `你的主型為 ${mainType}，融合${summary.top}能量與${summary.variant}地支特質。`;

  const col = (t, a) => `<div class='border rounded p-2'><b>${t}</b><ul class='list-disc pl-5'>${a.map(x => `<li>${x}</li>`).join('')}</ul></div>`;
  const ADVICE_DB = {
    青龍: { 職場: ["創新領頭，勇於嘗試新方法。", "注意風險評估，避免衝動。"], 感情: ["浪漫冒險，需穩定表達。"], 養生: ["戶外運動釋放能量。"] },
    朱雀: { 職場: ["激勵團隊，擅長溝通。"], 感情: ["熱情表達愛，保持真誠。"], 養生: ["藝術創作減壓。"] },
    勾陳: { 職場: ["穩定執行，注重細節。"], 感情: ["忠誠可靠，建立信任。"], 養生: ["規律作息，均衡飲食。"] },
    螣蛇: { 職場: ["協調衝突，善於傾聽。"], 感情: ["敏感體貼，深入溝通。"], 養生: ["冥想練習，調節情緒。"] },
    白虎: { 職場: ["決斷領導，追求效率。"], 感情: ["直接表達，勇於承諾。"], 養生: ["高強度運動，釋放壓力。"] },
    玄武: { 職場: ["策略規劃，長遠視野。"], 感情: ["理性分析，穩健關係。"], 養生: ["靜坐閱讀，養成內省。"] },
  };
  const beastAdvice = ADVICE_DB[summary.top] || { 職場: ["重視角色定位。"], 感情: ["真誠表達需求。"], 養生: ["早睡早起，穩定能量。"] };
  document.getElementById("adviceCols").innerHTML = col("職場建議", beastAdvice.職場) + col("感情建議", beastAdvice.感情) + col("養生建議", beastAdvice.養生);
}

// ========== 表單處理 ==========
document.getElementById("form").addEventListener("submit", e => {
  e.preventDefault();
  const scores = { 青龍: 0, 朱雀: 0, 勾陳: 0, 螣蛇: 0, 白虎: 0, 玄武: 0 };
  BANK.forEach((q, i) => scores[q.b] += parseInt(document.getElementById(`q${i}`).value));
  const summary = summarize(scores);
  renderRadar(scores);
  renderReport(summary, scores);
  localStorage.setItem("shen-shou-v7", JSON.stringify({ scores, summary }));
  
  // 顯示結果區域
  document.getElementById("result").style.display = "grid";
  document.getElementById("aiReport").style.display = "block";
  
  // 清除之前的AI結果
  document.getElementById("aiOut").textContent = '';
  document.getElementById("aiStatus").style.display = 'none';
  document.getElementById("btnRetry").style.display = 'none';
});

document.getElementById("btnFillMid").onclick = () => {
  document.querySelectorAll(".slider").forEach(s => s.value = 3);
  const filled = Array.from(document.querySelectorAll('input[type="range"]')).filter(s => s.value !== '3').length;
  document.getElementById("progress").textContent = `${filled}/30`;
};

document.getElementById("btnClear").onclick = () => {
  if (confirm('確定要重新開始測驗嗎？這將清除所有當前進度。')) {
    localStorage.removeItem("shen-shou-v7");
    document.getElementById("result").style.display = "none";
    document.getElementById("aiReport").style.display = "none";
    document.querySelectorAll(".slider").forEach(s => s.value = 3);
    document.getElementById("progress").textContent = '0/30';
    document.getElementById("aiOut").textContent = '';
    document.getElementById("aiStatus").style.display = 'none';
    document.getElementById("btnRetry").style.display = 'none';
    
    // 重新隨機題目順序
    initializeQuestions();
  }
};

// 分享結果
document.getElementById("btnShare").addEventListener("click", () => {
  html2canvas(document.getElementById("result")).then(canvas => {
    const link = document.createElement('a');
    link.download = 'shenshou-result.png';
    link.href = canvas.toDataURL();
    link.click();
  });
});

// ========== AI智能分析 ==========
// 模擬AI分析功能
function generateMockAIResponse(summary) {
  const mockResponses = {
    青龍: `🌸💖 哇塞！你是宇宙最閃亮的青龍${summary.variant}型小寶貝！😻✨

📊 能量分析：
青龍能量超無敵 (${summary.total}分)！創意小龍龍，腦洞大開！🌈 你是團隊中的點子王，總能帶來新鮮想法！

🧠 人格特質：
像韓風 MBTI 的 ENFP 小冒險家！😽 充滿好奇心，喜歡探索新事物，${summary.variant}時辰讓你更加靈活機智！

🌈 生活應用：
💼 職場：適合創意產業，帶領團隊突破傳統！
❤️ 感情：浪漫又熱情，需要能理解你天馬行空的伴侶！
🌱 養生：多接觸大自然，釋放創造力能量！

💰 金錢卦：震為雷卦，適合投資新興產業！

🎉 結語：青龍${summary.variant}型小可愛，繼續保持你的獨特魅力！💖`,

    朱雀: `🔥✨ 哇嗚！你是熱情四射的朱雀${summary.variant}型小太陽！😻🌟

📊 能量分析：
朱雀能量光芒萬丈！社交小天才，感染力超強！🌈 你是人群中的焦點，總能帶動氣氛！

🧠 人格特質：
像韓風 MBTI 的 ESFJ 小天使！😽 重視人際關係，情感豐富，${summary.variant}時辰讓你更加溫暖貼心！

🌈 生活應用：
💼 職場：適合教育、藝術、公關領域！
❤️ 感情：熱情表達愛，需要情感共鳴的伴侶！
🌱 養生：藝術創作是最好的減壓方式！

💰 金錢卦：離為火卦，人脈就是錢脈！

🎉 結語：朱雀${summary.variant}型小寶貝，你的熱情感染著每個人！💖`,

    白虎: `⚡️🌟 霸氣外露！你是果斷決策的白虎${summary.variant}型領袖！😼💪

📊 能量分析：
白虎能量強勢出擊！效率至上，行動力滿分！🌈 你是團隊的指揮官，總能帶領大家達成目標！

🧠 人格特質：
像韓風 MBTI 的 ENTJ 大將軍！😼 目標明確，決策果斷，${summary.variant}時辰讓你更加精準有力！

🌈 生活應用：
💼 職場：適合管理職位，帶領團隊衝刺！
❤️ 感情：直接表達愛，欣賞有能力的伴侶！
🌱 養生：高強度運動釋放壓力！

💰 金錢卦：乾為天卦，主動出擊創造財富！

🎉 結語：白虎${summary.variant}型領導者，繼續展現你的王者風範！💪✨`,

    玄武: `🌊🔮 深藏不露！你是智慧深沉的玄武${summary.variant}型思想家！😼🧠

📊 能量分析：
玄武能量深不可測！邏輯分析，策略規劃！🌈 你是團隊的智囊團，總能提出深遠見解！

🧠 人格特質：
像韓風 MBTI 的 INTJ 戰略家！😼 理性冷靜，善於規劃，${summary.variant}時辰讓你更加深思熟慮！

🌈 生活應用：
💼 職場：適合研究、分析、規劃職位！
❤️ 感情：理性經營感情，需要深度交流！
🌱 養生：靜坐冥想，培養內在平靜！

💰 金錢卦：坎為水卦，穩健理財累積財富！

🎉 結語：玄武${summary.variant}型智者，你的智慧是無價之寶！🧠💖`
  };

  return mockResponses[summary.top] || `🌟💫 獨一無二的${summary.top}${summary.variant}型寶貝！😻

你的能量組合非常特別，${summary.top}神獸與${summary.variant}時辰的結合創造出獨特魅力！

繼續探索自己的潛能，每個神獸都有其獨特的光彩！🌈✨

💖 記住：你是最棒的，繼續發光發熱！🎉`;
}

// 真實AI分析
document.getElementById("btnAI").addEventListener("click", async () => {
  const saved = JSON.parse(localStorage.getItem("shen-shou-v7") || "null");
  const out = document.getElementById("aiOut");
  const status = document.getElementById("aiStatus");
  
  if (!saved) { 
    out.textContent = "⚠️ 請先完成測驗再生成AI分析報告！";
    return; 
  }
  
  out.innerHTML = "";
  status.innerHTML = "🪶 AI 正在分析中，約5~15秒... <span class='spinner'>⏳</span>";
  status.style.display = "block";
  document.getElementById("btnRetry").style.display = "none";
  document.getElementById("btnMockAI").style.display = "none";
  
  try {
    // 嘗試多個可能的API端點
    const apiEndpoints = [
      "/api/ai",
      "http://localhost:3000/api/ai",
      "/api/analyze",
      "https://your-vercel-app.vercel.app/api/ai"
    ];
    
    let response = null;
    let lastError = null;
    
    for (const endpoint of apiEndpoints) {
      try {
        console.log(`嘗試連接: ${endpoint}`);
        response = await fetch(endpoint, { 
          method: "POST", 
          headers: { "Content-Type": "application/json" }, 
          body: JSON.stringify(saved),
          timeout: 30000
        });
        
        if (response.ok) {
          console.log(`成功連接到: ${endpoint}`);
          break;
        } else {
          lastError = `端點 ${endpoint} 返回狀態: ${response.status}`;
          console.log(lastError);
        }
      } catch (e) {
        lastError = `端點 ${endpoint} 失敗: ${e.message}`;
        console.log(lastError);
        continue;
      }
    }
    
    if (!response || !response.ok) {
      throw new Error(`無法連接到AI服務器。${lastError || '請檢查網絡連接或稍後重試。'}`);
    }
    
    const data = await response.json();
    
    if (data.error) {
      throw new Error(data.error);
    }
    
    if (!data.text) {
      throw new Error('AI服務器返回空回應');
    }
    
    out.textContent = data.text.trim();
    status.style.display = "none";
    
  } catch (err) {
    console.error('AI分析錯誤:', err);
    out.textContent = `❌ AI分析暫時無法使用\n\n錯誤信息: ${err.message}\n\n💡 建議:\n• 檢查網絡連接\n• 稍後再試\n• 或使用「模擬分析」功能繼續體驗`;
    status.style.display = "none";
    document.getElementById("btnRetry").style.display = "inline-block";
    document.getElementById("btnMockAI").style.display = "inline-block";
  }
});

// 模擬AI分析
document.getElementById("btnMockAI").addEventListener("click", () => {
  const saved = JSON.parse(localStorage.getItem("shen-shou-v7") || "null");
  const out = document.getElementById("aiOut");
  const status = document.getElementById("aiStatus");
  
  if (!saved) { 
    out.textContent = "⚠️ 請先完成測驗！";
    return; 
  }
  
  out.innerHTML = "";
  status.innerHTML = "🎨 生成模擬分析中... <span class='spinner'>⏳</span>";
  status.style.display = "block";
  
  setTimeout(() => {
    const mockResponse = generateMockAIResponse(saved.summary);
    out.textContent = mockResponse + "\n\n💫 註：這是模擬分析結果，僅供演示使用";
    status.style.display = "none";
    document.getElementById("btnMockAI").style.display = "none";
  }, 1500);
});

// 重試按鈕
document.getElementById("btnRetry").addEventListener("click", () => {
  document.getElementById("btnAI").click();
});

// ========== 初始化 ==========
document.addEventListener('DOMContentLoaded', function() {
  console.log('頁面加載完成，初始化測驗...');
  
  // 初始化題目
  initializeQuestions();
  
  // 檢查是否有保存的結果
  const savedData = localStorage.getItem('shen-shou-v7');
  if (savedData) {
    try {
      const data = JSON.parse(savedData);
      if (data.scores && data.summary) {
        // 顯示結果區域但不自動顯示內容
        document.getElementById("result").style.display = "grid";
        document.getElementById("aiReport").style.display = "block";
        console.log('載入已保存的測驗結果');
      }
    } catch (e) {
      console.log('載入保存數據失敗:', e);
      localStorage.removeItem("shen-shou-v7");
    }
  }
  
  console.log('測驗系統初始化完成！');
});

// 全局錯誤處理
window.addEventListener('error', function(e) {
  console.error('全局錯誤:', e.error);
});
</script>
</body>
</html>
