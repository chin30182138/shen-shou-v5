<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>神獸七十二型人格 測驗＋AI智能分析</title>
  <meta name="description" content="六獸人格AI分析｜金錢卦五行整合｜即時雷達圖＋智能報告" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root { --brand: #b6822b; }
    body { background: radial-gradient(circle at top left, #fffaf4, #f6f3ea); }
    .brand { color: var(--brand); }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
    .slider { accent-color: var(--brand); }
    .spinner { animation: spin 1s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* 列印樣式 */
    @media print { 
      .no-print { display: none !important; } 
      #form, header, footer { display: none !important; }
      body { 
        background: white !important; 
        font-size: 12px !important;
        padding: 10px !important;
        margin: 0 !important;
      }
      main {
        max-width: 100% !important;
        padding: 0 !important;
      }
      .card { 
        box-shadow: none !important; 
        border: 1px solid #999 !important;
        margin-bottom: 15px !important;
        break-inside: avoid;
        page-break-inside: avoid;
      }
      #result {
        display: grid !important;
        grid-template-columns: 45% 55% !important;
        gap: 15px !important;
        margin-bottom: 20px !important;
      }
      /* 雷達圖容器保持正方形 */
      #radar-container {
        position: relative;
        width: 100% !important;
        height: 0 !important;
        padding-bottom: 100% !important; /* 保持1:1比例 */
      }
      #radar {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
      }
      #resultCard {
        font-size: 11px !important;
      }
      #aiReport {
        display: block !important;
        page-break-before: always;
        margin-top: 20px !important;
      }
      #aiOut {
        font-size: 11px !important;
        line-height: 1.3 !important;
        max-height: none !important;
      }
      h1, h2 {
        color: black !important;
        margin-bottom: 8px !important;
      }
      .print-only { display: block !important; }
      .print-header {
        text-align: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #b6822b;
      }
      .print-header h1 {
        font-size: 18px !important;
        margin-bottom: 5px !important;
      }
      .print-header p {
        font-size: 12px !important;
        color: #666 !important;
      }
    }
    
    .print-only { display: none; }
    
    /* 網頁顯示時的雷達圖樣式 */
    #radar {
      width: 100% !important;
      height: 300px !important;
    }
  </style>
</head>
<body class="text-slate-800">
<main class="max-w-5xl mx-auto p-4 sm:p-6">
  <header class="mb-4 flex justify-between items-center no-print">
    <div class="flex items-center gap-3">
      <img src="img/logo.png" class="h-10 w-auto rounded" alt="仙人指路 Logo" />
      <div>
        <h1 class="text-2xl sm:text-3xl font-extrabold brand">神獸七十二型人格 測驗＋AI智能分析</h1>
        <p class="text-sm text-slate-600">六獸雷達圖・主型解析・三欄建議・AI分析報告</p>
      </div>
    </div>
  </header>

  <!-- 問卷 -->
  <form id="form" class="card p-4 mb-4 no-print">
    <h2 class="font-bold mb-3">📋 請回答下列30題（1＝不同意，5＝非常同意）</h2>
    <ol id="qWrap" class="space-y-3"></ol>
    <div class="mt-4 flex gap-3">
      <button type="submit" class="bg-amber-600 text-white px-5 py-2 rounded">送出測驗</button>
      <button type="button" id="btnFillMid" class="border px-3 py-2 rounded">全部填3</button>
    </div>
  </form>

  <!-- 列印專用標題 -->
  <div class="print-only print-header">
    <h1>神獸人格分析報告</h1>
    <p>個人專屬分析結果</p>
  </div>

  <!-- 結果 - 初始隱藏 -->
  <section id="result" class="grid lg:grid-cols-2 gap-4" style="display: none;">
    <div class="card p-4">
      <h2 class="font-bold mb-2">六獸能量雷達圖</h2>
      <div id="radar-container">
        <canvas id="radar"></canvas>
      </div>
      <button class="mt-3 px-4 py-2 border rounded no-print" onclick="printAnalysis()">🖨️ 列印分析報告</button>
    </div>
    <div class="card p-4" id="resultCard">
      <h2 class="font-bold mb-2">主型與三欄建議</h2>
      <div class="grid grid-cols-3 gap-3 items-start">
        <div id="beastSVG" class="w-full aspect-square"></div>
        <div class="col-span-2">
          <div id="mainBeastTitle" class="font-bold brand"></div>
          <div id="dualHint" class="text-sm text-slate-600"></div>
          <div id="mainBeastSummary" class="mt-1 text-sm"></div>
        </div>
      </div>
      <hr class="my-2" />
      <div id="adviceCols" class="grid md:grid-cols-3 gap-2 text-sm"></div>
      <div class="mt-4 flex gap-2 no-print">
        <button id="btnShare" class="px-4 py-2 border rounded">分享結果圖片</button>
        <button class="px-4 py-2 border rounded" onclick="printAnalysis()">🖨️ 列印分析報告</button>
      </div>
    </div>
  </section>

  <!-- AI 智能分析 - 初始隱藏 -->
  <section class="card p-4 mt-4" id="aiReport" style="display: none;">
    <h2 class="font-bold mb-2">🤖 AI 智能個人化分析報告</h2>
    <p class="text-sm text-slate-600 mb-3">以下內容由仙人指路AI系統生成，融合金錢卦、五行、地支與心理視角。</p>
    <div class="flex gap-2 no-print">
      <button id="btnAI" class="px-4 py-2 border rounded">生成分析報告</button>
      <button id="btnRetry" class="px-4 py-2 border rounded bg-gray-200" style="display:none;">重試</button>
      <button class="px-4 py-2 border rounded" onclick="printAnalysis()">🖨️ 列印完整報告</button>
    </div>
    <pre id="aiOut" class="mt-3 text-sm bg-slate-50 p-3 rounded-lg whitespace-pre-wrap leading-relaxed"></pre>
  </section>

  <footer class="text-center text-xs text-slate-500 mt-8 no-print">
    © 2025 仙人指路占卜研究學會｜測驗僅供覺察與教學用途
  </footer>
</main>

<script>
// 列印功能
function printAnalysis() {
  window.print();
}

// ========== 題庫 ==========
const BANK = [
  {t:"我常有突如其來的靈感並想立即嘗試。",b:"青龍"},
  {t:"我喜歡打破常規尋找新方法。",b:"青龍"},
  {t:"遇阻力時我會靈活轉向。",b:"青龍"},
  {t:"我富想像力，喜歡創新思考。",b:"青龍"},
  {t:"我熱愛探索未知事物。",b:"青龍"},
  {t:"我喜歡在人群中表達自己。",b:"朱雀"},
  {t:"我用情緒帶動他人。",b:"朱雀"},
  {t:"別人的反應會影響我。",b:"朱雀"},
  {t:"我擅長說服與演說。",b:"朱雀"},
  {t:"我重視被傾聽與關注。",b:"朱雀"},
  {t:"我喜歡按計畫行事。",b:"勾陳"},
  {t:"我重視安全感與穩定。",b:"勾陳"},
  {t:"我責任感強。",b:"勾陳"},
  {t:"我傾向維持現狀。",b:"勾陳"},
  {t:"我注重細節與程序。",b:"勾陳"},
  {t:"我對他人情緒很敏感。",b:"螣蛇"},
  {t:"我擅長觀察與傾聽。",b:"螣蛇"},
  {t:"我常思考背後的動機。",b:"螣蛇"},
  {t:"我思考事情會考量時機與人心。",b:"螣蛇"},
  {t:"我善於協調不同觀點。",b:"螣蛇"},
  {t:"我講求效率與結果。",b:"白虎"},
  {t:"我會主動做決策。",b:"白虎"},
  {t:"我以數據與成果為導向。",b:"白虎"},
  {t:"我願意承擔壓力以完成任務。",b:"白虎"},
  {t:"我偏好明確的規範與標準。",b:"白虎"},
  {t:"我喜歡獨自思考。",b:"玄武"},
  {t:"我傾向謹慎評估後行動。",b:"玄武"},
  {t:"我擅長規劃長遠目標。",b:"玄武"},
  {t:"我重視邏輯與分析。",b:"玄武"},
  {t:"我習慣冷靜看待問題。",b:"玄武"},
];

// 隨機題目
BANK.sort(() => Math.random() - 0.5);
const qWrap = document.getElementById("qWrap");
BANK.forEach((q, i) => {
  qWrap.innerHTML += `<li><p>${i+1}. ${q.t}</p><input type='range' min='1' max='5' value='3' id='q${i}' class='w-full slider'></li>`;
});

// 進度條
qWrap.innerHTML += `<div id="progress" class="text-right text-sm">0/30</div>`;
document.querySelectorAll('input[type="range"]').forEach(s => {
  s.onchange = () => {
    const filled = Array.from(document.querySelectorAll('input[type="range"]')).filter(s => s.value !== '3').length;
    document.getElementById("progress").textContent = `${filled}/30`;
  };
});

// ========== 神獸SVG ==========
function beastSVG(name) {
  const stroke = '#B6822B', fill = 'none';
  const s = d => `<path d='${d}' fill='${fill}' stroke='${stroke}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>`;
  const base = d => `<svg viewBox='0 0 100 100' class='w-full h-auto' xmlns='http://www.w3.org/2000/svg'>
    <defs><radialGradient id='g' cx='50%' cy='50%' r='60%'>
      <stop offset='0%' stop-color='rgba(182,130,43,0.25)'/><stop offset='100%' stop-color='rgba(182,130,43,0)'/>
    </radialGradient></defs><rect width='100' height='100' fill='url(#g)'/>${d}</svg>`;
  switch (name) {
    case '青龍': return base(s("M15 60 C25 40, 45 35, 55 45 C65 55, 75 35, 85 45 M45 45 q5 -12 16 -10 m-6 6 l6 4 m-36 20 q10 -6 18 2 m12 -2 q8 -6 18 2") + s("M30 70 q10 8 20 0 q10 -8 20 0"));
    case '朱雀': return base(s("M20 60 q15 -30 30 -30 q15 0 30 30 M50 30 l0 12 M35 55 q15 -8 30 0 M25 62 q10 8 25 8 q15 0 25 -8"));
    case '勾陳': return base(s("M20 70 h60 v-20 h-60 v20 z M30 50 v-10 h40 v10 M35 65 h10 M55 65 h10"));
    case '螣蛇': return base(s("M20 70 q20 -30 40 -10 q10 8 20 -2 q-10 20 -30 10 q-10 -6 -30 2 M60 48 q6 -6 12 0"));
    case '白虎': return base(s("M20 65 q15 -20 30 -20 q15 0 30 20 M30 60 h40 M35 70 h30 M38 52 l4 6 M58 52 l-4 6"));
    case '玄武': return base(s("M30 65 q20 15 40 0 q5 -12 -15 -22 q-20 10 -25 22 M55 50 q10 -8 20 2 M25 55 q-8 -6 -10 6"));
    default: return base('');
  }
}

// ========== 動態建議生成 ==========
function generateAdvice(mainBeast, secondaryBeast, scores, variant) {
  const adviceTemplates = {
    青龍: {
      職場: [
        "創新領頭，勇於嘗試新方法",
        "帶領團隊突破傳統框架",
        "開拓新市場或業務領域",
        "將創意轉化為實際行動"
      ],
      感情: [
        "保持關係中的新鮮感",
        "共同探索新體驗",
        "開放溝通創新想法",
        "平衡冒險與穩定需求"
      ],
      養生: [
        "戶外運動釋放能量",
        "嘗試新的運動方式",
        "保持生活多樣性",
        "適當冒險挑戰自我"
      ]
    },
    朱雀: {
      職場: [
        "發揮表達與溝通優勢",
        "激勵團隊士氣",
        "建立廣泛人際網絡",
        "展現熱情與感染力"
      ],
      感情: [
        "真誠表達情感需求",
        "創造浪漫驚喜時刻",
        "保持關係中的熱情",
        "適度分享內心感受"
      ],
      養生: [
        "藝術創作抒發情感",
        "社交活動保持活力",
        "表達性運動如舞蹈",
        "注意情緒波動管理"
      ]
    },
    勾陳: {
      職場: [
        "建立穩定工作流程",
        "確保任務按時完成",
        "注重細節與品質",
        "提供可靠支持"
      ],
      感情: [
        "建立信任與安全感",
        "保持承諾與一致性",
        "穩定表達關心",
        "營造溫馨家庭氛圍"
      ],
      養生: [
        "規律作息保持平衡",
        "均衡飲食與運動",
        "建立健康生活習慣",
        "注重實際養生方法"
      ]
    },
    螣蛇: {
      職場: [
        "發揮洞察與協調能力",
        "理解團隊成員需求",
        "妥善處理人際關係",
        "把握時機採取行動"
      ],
      感情: [
        "深入理解伴侶感受",
        "敏感體貼對方需求",
        "建立深度情感連結",
        "適時表達支持"
      ],
      養生: [
        "冥想與內省練習",
        "情緒管理與釋放",
        "溫和調理身心",
        "注重心理平衡"
      ]
    },
    白虎: {
      職場: [
        "果斷決策追求效率",
        "設定明確目標",
        "承擔領導責任",
        "注重成果與績效"
      ],
      感情: [
        "直接表達愛與承諾",
        "保護與支持伴侶",
        "明確關係界線",
        "展現堅定與忠誠"
      ],
      養生: [
        "高強度運動釋壓",
        "挑戰體能極限",
        "培養紀律性",
        "注意壓力管理"
      ]
    },
    玄武: {
      職場: [
        "策略規劃長遠發展",
        "深入分析問題本質",
        "獨立思考與判斷",
        "保持理性與客觀"
      ],
      感情: [
        "深度交流思想",
        "理性分析關係",
        "保持個人空間",
        "建立智慧連結"
      ],
      養生: [
        "靜坐與閱讀",
        "深度思考與反思",
        "獨立運動如游泳",
        "注重精神養生"
      ]
    }
  };

  // 根據分數選擇建議強度
  const getAdviceIntensity = (score) => {
    if (score >= 20) return 0; // 最強烈的建議
    if (score >= 15) return 1;
    if (score >= 10) return 2;
    return 3; // 最溫和的建議
  };

  const mainScore = scores[mainBeast];
  const secondaryScore = secondaryBeast ? scores[secondaryBeast] : 0;
  
  const mainIntensity = getAdviceIntensity(mainScore);
  const secondaryIntensity = getAdviceIntensity(secondaryScore);

  // 組合主要和次要神獸的建議
  const combineAdvice = (category) => {
    const mainAdvices = adviceTemplates[mainBeast][category];
    const secondaryAdvices = secondaryBeast ? adviceTemplates[secondaryBeast][category] : [];
    
    let combined = [];
    
    // 主要神獸建議
    if (mainAdvices && mainAdvices[mainIntensity]) {
      combined.push(mainAdvices[mainIntensity] + "。");
    }
    
    // 次要神獸建議（如果存在且分數足夠高）
    if (secondaryBeast && secondaryScore >= 10 && secondaryAdvices && secondaryAdvices[secondaryIntensity]) {
      combined.push(secondaryAdvices[secondaryIntensity] + "。");
    }
    
    // 確保至少有2條建議
    while (combined.length < 2) {
      const randomIndex = Math.floor(Math.random() * mainAdvices.length);
      if (!combined.includes(mainAdvices[randomIndex] + "。")) {
        combined.push(mainAdvices[randomIndex] + "。");
      }
    }
    
    return combined;
  };

  return {
    職場: combineAdvice('職場'),
    感情: combineAdvice('感情'), 
    養生: combineAdvice('養生')
  };
}

// ========== 結果生成 ==========
function summarize(scores) {
  const arr = Object.entries(scores).sort((a, b) => b[1] - a[1]);
  const top = arr[0], second = arr[1];
  const dual = (top[1] - second[1] <= 2) ? [top[0], second[0]] : null;
  const total = Object.values(scores).reduce((a, b) => a + b, 0);
  const variantIdx = total % 12;
  const variants = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥'];
  const variant = variants[variantIdx];
  return { top: top[0], dual, ranking: arr, variant, total, scores };
}

let radarChart = null;
function renderRadar(scores) {
  const ctx = document.getElementById("radar");
  if (radarChart) radarChart.destroy();
  radarChart = new Chart(ctx, {
    type: "radar",
    data: { labels: Object.keys(scores), datasets: [{ label: "六獸能量", data: Object.values(scores), backgroundColor: "rgba(182,130,43,0.15)", borderColor: "#b6822b" }] },
    options: { 
      scales: { r: { suggestedMin: 0, suggestedMax: 25, ticks: { stepSize: 5 } } }, 
      plugins: { legend: { display: false } },
      maintainAspectRatio: true
    }
  });
}

function renderReport(summary, scores) {
  document.getElementById("beastSVG").innerHTML = beastSVG(summary.top);
  const mainType = `${summary.top}${summary.variant}型`;
  document.getElementById("mainBeastTitle").textContent = summary.dual ? `雙獸${summary.variant}型：${summary.top} × ${summary.dual[1]}` : `主${summary.variant}型：${summary.top}`;
  document.getElementById("dualHint").textContent = summary.dual ? `第二主導能量：${summary.dual[1]}` : '';
  document.getElementById("mainBeastSummary").textContent = `你的主型為 ${mainType}，融合${summary.top}能量與${summary.variant}地支特質。`;

  // 生成動態建議
  const advice = generateAdvice(summary.top, summary.dual ? summary.dual[1] : null, scores, summary.variant);
  
  const col = (t, a) => `<div class='border rounded p-2'><b>${t}</b><ul class='list-disc pl-5'>${a.map(x => `<li>${x}</li>`).join('')}</ul></div>`;
  document.getElementById("adviceCols").innerHTML = col("職場建議", advice.職場) + col("感情建議", advice.感情) + col("養生建議", advice.養生);
}

document.getElementById("form").addEventListener("submit", e => {
  e.preventDefault();
  const scores = { 青龍: 0, 朱雀: 0, 勾陳: 0, 螣蛇: 0, 白虎: 0, 玄武: 0 };
  BANK.forEach((q, i) => scores[q.b] += parseInt(document.getElementById(`q${i}`).value));
  const summary = summarize(scores);
  renderRadar(scores);
  renderReport(summary, scores);
  localStorage.setItem("shen-shou-v7", JSON.stringify({ scores, summary }));
  
  // 顯示結果區域
  document.getElementById("result").style.display = "grid";
  document.getElementById("aiReport").style.display = "block";
});

document.getElementById("btnFillMid").onclick = () => document.querySelectorAll(".slider").forEach(s => s.value = 3);

// 分享結果
document.getElementById("btnShare").addEventListener("click", () => {
  html2canvas(document.getElementById("result")).then(canvas => {
    const link = document.createElement('a');
    link.download = 'shenshou-result.png';
    link.href = canvas.toDataURL();
    link.click();
  });
});

// ========== AI智能分析 ==========
document.getElementById("btnAI").addEventListener("click", async () => {
  const saved = JSON.parse(localStorage.getItem("shen-shou-v7") || "null");
  const out = document.getElementById("aiOut");
  if (!saved) { out.textContent = "⚠️請先完成測驗。"; return; }
  out.innerHTML = "🪶 AI 正在分析中，約5~10秒... <span class='spinner'>⏳</span>";
  document.getElementById("btnRetry").style.display = "none";
  try {
    const resp = await fetch("/api/ai", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(saved) });
    if (!resp.ok) throw new Error(await resp.text());
    const data = await resp.json();
    out.textContent = data.text.trim();
  } catch (err) {
    out.textContent = `❌分析失敗：後端服務暫時不可用\n\n💡 請確認：\n1. 後端服務是否運行\n2. API Key 是否正確設定\n3. 或稍後再試`;
    document.getElementById("btnRetry").style.display = "inline-block";
  }
});

document.getElementById("btnRetry").addEventListener("click", () => {
  document.getElementById("btnAI").click();
});
</script>
</body>
</html>
