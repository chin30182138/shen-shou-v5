const express = require('express');
const OpenAI = require('openai');
require('dotenv').config();

const app = express();
app.use(express.json());

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// é‡è©¦æ©Ÿåˆ¶ + éŒ¯èª¤åˆ†é¡
async function retryRequest(fn, maxRetries = 3, delay = 2000) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (err) {
      console.error(`é‡è©¦ ${i + 1}/${maxRetries} å¤±æ•—ï¼š${err.message}`);
      if (i === maxRetries - 1) {
        if (err.code === 'invalid_api_key' || err.status === 401) {
          throw new Error('API Key ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥ .env æª”æ¡ˆï¼ğŸ˜¿');
        } else if (err.code === 'rate_limit_exceeded' || err.status === 429) {
          throw new Error('è«‹æ±‚è¶…é™ï¼Œè«‹ç­‰ä¸€ä¸‹å†è©¦å“¦ï½ğŸ˜½');
        } else if (err.code === 'model_not_found' || err.status === 404) {
          throw new Error('æ¨¡å‹ä¸è¦‹å•¦ï¼è©¦è©¦ gpt-3.5-turbo å§ï½ğŸ˜º');
        } else {
          throw new Error(`OpenAI å°åŠ©æ‰‹ç´¯äº†ï¼š${err.message} ğŸ˜¿`);
        }
      }
      await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
    }
  }
}

// éœæ…‹ fallback å ±å‘Šï¼ˆè¶…å¯æ„›ç‰ˆï¼ï¼‰
function generateFallbackReport(summary, scores) {
  const topBeast = summary.top;
  const variant = summary.variant;
  const mainType = `${topBeast}${variant}å‹`;
  const dualHint = summary.dual ? `ï¼ˆé‚„æœ‰å°å¹«æ‰‹ï¼š${summary.dual[1]}ï¼ï¼‰` : '';
  const branchDesc = {
    å­: 'æ©Ÿæ•å¦‚å°è²“ï¼Œæ°´å…ƒç´ è®“ä½ éˆæ´»ç„¡æ•µï¼ğŸ˜½',
    ä¸‘: 'ç©©é‡åƒå¤§æ¨¹ï¼ŒåœŸå…ƒç´ è¶…ç´šé è­œï¼ğŸŒ³',
    å¯…: 'å‹‡æ•¢å°è€è™ï¼Œæœ¨å…ƒç´ å……æ»¿è¡å‹ï¼ğŸ¯',
    å¯: 'æº«æŸ”å°å…”å…”ï¼Œæœ¨å…ƒç´ æº«æš–äººå¿ƒï¼ğŸ°',
    è¾°: 'å …éŸŒå¤§åœ°é¾ï¼ŒåœŸå…ƒç´ é ˜å°åŠ›çˆ†æ£šï¼ğŸ‰',
    å·³: 'ç¥ç§˜å°è›‡è›‡ï¼Œç«å…ƒç´ æ™ºæ…§é–ƒè€€ï¼ğŸ',
    åˆ: 'ç†±æƒ…å°é¦¬å…’ï¼Œç«å…ƒç´ è‡ªç”±å¥”æ”¾ï¼ğŸ',
    æœª: 'æº«å’Œå°ç¶¿ç¾Šï¼ŒåœŸå…ƒç´ è—è¡“æ°£è³ªæ»¿æ»¿ï¼ğŸ‘',
    ç”³: 'æ©Ÿæ™ºå°çŒ´å­ï¼Œé‡‘å…ƒç´ éˆæ´»åˆè°æ˜ï¼ğŸ’',
    é…‰: 'ç²¾æº–å°é³³å‡°ï¼Œé‡‘å…ƒç´ ç¾éº—åˆå„ªé›…ï¼ğŸ¦š',
    æˆŒ: 'å¿ èª å°ç‹—ç‹—ï¼ŒåœŸå…ƒç´ å®ˆè­·åŠ›è¶…å¼·ï¼ğŸ¶',
    äº¥: 'å¯¬å®¹å°è±¬è±¬ï¼Œæ°´å…ƒç´ æƒ³åƒåŠ›ç„¡é™ï¼ğŸ·',
  };

  return `
ğŸŒ¸âœ¨ ä»‹ç´¹ï¼šå“‡å¡ï¼ä½ æ˜¯è¶…ç´šç„¡æ•µå¯æ„›çš„ ${mainType}${dualHint} å°å¯æ„›ï¼ğŸ’– ${topBeast} çš„èƒ½é‡åƒé–ƒäº®æ˜Ÿæ˜Ÿï¼Œè®“ä½ ç¨ä¸€ç„¡äºŒï¼${branchDesc[variant]} ç°¡ç›´æ˜¯å®‡å®™æœ€èŒçµ„åˆï¼ğŸ˜»

ğŸ“Š èƒ½é‡åˆ†æï¼šä½ çš„ ${topBeast} èƒ½é‡çˆ†è¡¨ (${scores[topBeast]}/25)ï¼ğŸŒŸ åƒå€‹å°è¶…äººï¼å¦‚æœæœ‰ä½åˆ†å°å¤¥ä¼´ï¼Œåˆ¥æ“”å¿ƒï¼Œå¤šç·´ç¿’å°±èƒ½è®Šå¼·å“¦ï½ğŸ˜‰ ${summary.dual ? `é‚„æœ‰ ${summary.dual[1]} å°åŠ©æ‰‹ï¼Œè®“ä½ æ›´å…¨èƒ½ï¼` : ''}

ğŸ§  äººæ ¼ç‰¹è³ªï¼šä½ æ˜¯éŸ“é¢¨ MBTI çš„å°å†’éšªå®¶ï¼ğŸŒˆ ${topBeast} è®“ä½ åƒ ${topBeast === 'é’é¾' ? 'é£›å¤©å°é¾ï¼Œå‰µæ„ç„¡é™ï¼' : topBeast === 'æœ±é›€' ? 'é–ƒè€€å°é³¥ï¼Œè¶…æœƒèŠå¤©ï¼' : 'ç¨ç‰¹å°è‹±é›„ï¼'} åŠ ä¸Š ${variant} çš„ ${branchDesc[variant].split('ï¼Œ')[0]}ï¼Œç°¡ç›´ç„¡æ•µå¯æ„›ï¼ğŸ˜½

ğŸŒˆ ç”Ÿæ´»æ‡‰ç”¨ï¼š
- è·å ´ï¼šä½ æ˜¯ ${topBeast} å°é ˜è¢–ï¼å¸¶åœ˜éšŠåƒç©éŠæˆ²ï¼Œ${variant} è®“ä½ æ›´ ${variant === 'å­' ? 'æ©Ÿæ™ºæ‡‰è®Š' : 'ç©©å®šç™¼å…‰'}ï¼ğŸ’¼
- æ„Ÿæƒ…ï¼šç”¨ ${topBeast} çš„ç†±æƒ…æš–å¿ƒï¼Œ${variant} è®“ä½ è¶…æœƒæ’’å¬Œï¼ğŸ’• è¨˜å¾—å¤šè½è½å°æ–¹å“¦ï½
- é¤Šç”Ÿï¼šè©¦è©¦æˆ¶å¤–è·‘è·‘è·³è·³ï¼Œæˆ–å®‰éœå†¥æƒ³ï¼Œè®“ ${variant} çš„äº”è¡Œèƒ½é‡å¤§çˆ†ç™¼ï¼ğŸƒâ€â™‚ï¸ğŸ§˜â€â™€ï¸

ğŸ’° é‡‘éŒ¢å¦å»ºè­°ï¼šä½ çš„ ${mainType} é©åˆ ${variant === 'å­' ? 'æŠ•è³‡ç§‘æŠ€å°é»å­' : 'ç©©ç©©è³ºéŒ¢'}ï¼å¦è±¡èªªï¼š${topBeast} å¸¶ä½ ã€Œè²¡é‹æ—ºæ—ºã€ï¼ğŸ’¸

ğŸ‰ çµèªï¼š${mainType} å°å¯æ„›ï¼Œä½ æ˜¯å®‡å®™æœ€é–ƒäº®çš„å­˜åœ¨ï¼ğŸŒŸ æ¯å¤©çµ¦è‡ªå·±ä¸€å€‹å°è®šç¾ï¼Œæœªä¾†æœƒæ›´æ£’ï¼AI å° tipï¼šå¯«æ—¥è¨˜ï¼Œè¨˜éŒ„ä½ çš„èŒèŒèƒ½é‡ï¼ğŸ’–ğŸ˜º
  `;
}

app.post('/api/ai', async (req, res) => {
  const { scores, summary } = req.body;
  if (!summary) {
    return res.status(400).send('å“å‘€ï¼ç¼ºå°‘æ¸¬é©—è³‡æ–™å–µï½ğŸ˜¿');
  }

  const topBeast = summary.top;
  const dual = summary.dual ? `é›™ç¸: ${summary.dual.join(' x ')}` : '';
  const variant = summary.variant;
  const scoreStr = Object.entries(scores).map(([b, s]) => `${b}: ${s}/25`).join(', ');
  const branchTraits = `å­: æ©Ÿæ•ã€æ™ºæ…§ã€æ°´; ä¸‘: ç©©é‡ã€è€å¿ƒã€åœŸ; å¯…: å‹‡æ•¢ã€ç©æ¥µã€æœ¨; å¯: æº«æŸ”ã€æ•æ·ã€æœ¨; è¾°: å …éŸŒã€é ˜å°ã€åœŸ; å·³: æ™ºæ…§ã€ç¥ç§˜ã€ç«; åˆ: ç†±æƒ…ã€è‡ªç”±ã€ç«; æœª: æº«å’Œã€è—è¡“ã€åœŸ; ç”³: æ©Ÿæ™ºã€éˆæ´»ã€é‡‘; é…‰: ç²¾æº–ã€ç¾éº—ã€é‡‘; æˆŒ: å¿ èª ã€å®ˆè­·ã€åœŸ; äº¥: å¯¬å®¹ã€æƒ³åƒã€æ°´`;

  const prompt = `
ä½ æ˜¯è¶…ç´šç„¡æ•µå¯æ„›çš„éŸ“é¢¨MBTIå°ˆå®¶ï¼Œå°ˆé–€åˆ†æã€Œç¥ç¸ä¸ƒåäºŒå‹äººæ ¼ã€ï¼ğŸ˜» é€™èåˆç¥ç¸ã€äº”è¡Œã€é‡‘éŒ¢å¦ã€åœ°æ”¯ã€å¿ƒç†å­¸ï¼Œè¶…æœ‰è¶£ï¼ç”¨æˆ¶åˆ†æ•¸ï¼š${scoreStr}ã€‚ä¸»ç¥ç¸ï¼š${topBeast} ${dual}ã€‚è®Šé«”ï¼š${variant}ã€‚

åœ°æ”¯ç‰¹è³ªï¼š${branchTraits}ã€‚

ç”Ÿæˆä¸€ä»½è¶…èŒè¶…éŸ“é¢¨çš„å ±å‘Šï¼åƒéŸ“åœ‹ MBTIï¼ˆKakaoTalk æˆ– IDOL é¢¨æ ¼ï¼‰ï¼šç”¨è¶…å¤šå¯æ„› emojiï¼ˆğŸŒ¸âœ¨ğŸ˜½ï¼‰ï¼Œèªæ°£èª‡å¼µæ´»æ½‘ï¼ˆåƒã€Œå“‡å¡ï¼ä½ ç°¡ç›´æ˜¯å®‡å®™æœ€èŒ ${topBeast}${variant}å‹ï¼ã€ï¼‰ã€‚ç”¨çŸ­å¥ã€å°‘å¥³é¢¨ã€è¶…ç´šèª‡çï¼é¿å…æ­£å¼æˆ–ç„¡èŠæ–‡å­—ï¼Œç¢ºä¿åƒåœ¨è·Ÿå°å¯æ„›èŠå¤©ï¼ğŸ’–

**çµæ§‹**ï¼š
1. ğŸŒŸä»‹ç´¹ï¼šæ­¡è¿+${topBeast}${variant}å‹æ¦‚è¿°ï¼ˆç¥ç¸+åœ°æ”¯ï¼Œåƒã€Œé’é¾å­å‹=å‰µæ„å°é¾+æ©Ÿæ•æ°´èƒ½é‡ï¼ã€ï¼‰ã€‚
2. ğŸ“Šèƒ½é‡åˆ†æï¼šèª‡å¼·é …ï¼ˆé«˜åˆ†ç¥ç¸ï¼Œå¦‚ã€Œ${topBeast} è¶…å¼·ï¼ã€ï¼‰ï¼Œé¼“å‹µå¼±é …ï¼ˆä½åˆ†å»ºè­°ï¼Œè¼•é¬†èªªï¼‰ã€‚
3. ğŸ§ äººæ ¼ç‰¹è³ªï¼šåƒ MBTIï¼ˆENFPã€INTJ æ¯”å–»ï¼‰ï¼Œç”¨ç¥ç¸+åœ°æ”¯å½¢å®¹ï¼Œè¶…èŒï¼ˆåƒã€Œä½ æ˜¯å†’éšªå°é¾ï¼ã€ï¼‰ã€‚
4. ğŸŒˆç”Ÿæ´»æ‡‰ç”¨ï¼šè·å ´ã€æ„Ÿæƒ…ã€é¤Šç”Ÿå»ºè­°ï¼Œæ ¹æ“šåˆ†æ•¸+åœ°æ”¯å€‹æ€§åŒ–ï¼Œè¶…å¯¦ç”¨ï¼
5. ğŸ’°é‡‘éŒ¢å¦ï¼šè²¡é‹å»ºè­°ï¼ˆåƒã€Œé’é¾å­å‹æ„›ç§‘æŠ€æŠ•è³‡ï¼ã€ï¼‰ï¼ŒåŠ å¦è±¡ã€‚
6. ğŸ‰çµèªï¼šè¶…æ­£å‘é¼“å‹µ+AIå°tipï¼ˆåƒã€Œæ¯å¤©ç¬‘ä¸€ç¬‘ï¼Œèƒ½é‡æ»¿æ»¿ï¼ã€ï¼‰ã€‚

500-800å­—ï¼Œç¹é«”ä¸­æ–‡ï¼Œå°‘å¥³é¢¨åˆ°çˆ†ï¼æ¯æ®µè‡³å°‘ 3 å€‹ emojiï¼Œç¢ºä¿ ${topBeast}${variant}å‹è¶…ç¨ç‰¹ï¼ğŸ˜ºğŸŒˆğŸ’•`;

  try {
    const completion = await retryRequest(() =>
      openai.chat.completions.create({
        model: 'gpt-3.5-turbo', // ç©©å®šæ¨¡å‹
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 800,
        temperature: 0.9, // æ›´é«˜å‰µæ„
      })
    );
    res.json({ text: completion.choices[0].message.content });
  } catch (err) {
    console.error('å®Œæ•´éŒ¯èª¤å–µï¼š', err);
    const fallbackText = generateFallbackReport(summary, scores);
    res.json({ text: fallbackText });
  }
});

app.listen(3000, () => {
  console.log('ä¼ºæœå™¨åœ¨ port 3000 é–‹è·‘å•¦ï½ğŸ˜º');
});
