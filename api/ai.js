const express = require('express');
const router = express.Router();

// 添加 CORS 支援
router.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE');
    res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
    next();
});

// AI分析處理函數
router.post('/', async (req, res) => {
    try {
        console.log('收到 AI 分析請求');
        
        const { scores, summary, gender, questions } = req.body;
        
        // 驗證必要資料
        if (!scores || !summary) {
            console.log('缺少必要的測驗資料');
            return res.status(400).json({
                success: false,
                error: '缺少必要的測驗資料'
            });
        }
        
        console.log('開始生成 AI 分析...');
        
        // 調用AI分析服務
        const analysis = await generateAIAnalysis({
            scores,
            summary,
            gender,
            questions
        });
        
        console.log('AI 分析生成完成');
        
        res.json({
            success: true,
            analysis: analysis
        });
        
    } catch (error) {
        console.error('AI分析錯誤:', error);
        res.status(500).json({
            success: false,
            error: 'AI分析服務暫時不可用，請稍後再試'
        });
    }
});

// AI分析生成函數
async function generateAIAnalysis(data) {
    const { scores, summary, gender, questions } = data;
    const beastType = summary.top;
    
    // 這裡可以整合真正的AI服務
    const analysis = {
        personality: await generatePersonalityAnalysis(beastType, gender, scores),
        strengths: await generateStrengthsAnalysis(beastType, scores),
        career: await generateCareerAnalysis(beastType, summary),
        relationships: await generateRelationshipsAnalysis(beastType, scores),
        growth: await generateGrowthAnalysis(beastType, summary),
        money: await generateMoneyAnalysis(beastType, summary)
    };
    
    return analysis;
}

// 人格特質分析
async function generatePersonalityAnalysis(beastType, gender, scores) {
    const baseAnalysis = {
        '青龍': `根據您的測驗結果，您屬於「青龍」類型的人格特質。這表示您具有以下核心特徵：

• 創新思維：您的大腦就像一個創意發電機，總能產生新穎的想法和解決方案
• 靈活適應：面對變化時，您能快速調整策略，找到新的可能性
• 突破框架：您不喜歡被傳統束縛，善於打破常規尋找更好的方法

您的青龍能量得分為 ${scores['青龍']}，這表明您在創意和靈活性方面有顯著優勢。`,

        '朱雀': `根據您的測驗結果，您屬於「朱雀」類型的人格特質。這表示您具有以下核心特徵：

• 情感豐富：您擁有充沛的情感能量，能夠真誠地表達自己
• 溝通天賦：您是天生的溝通者，擅長用語言和情感打動他人
• 激勵他人：您的熱情具有感染力，能夠激發團隊的活力

您的朱雀能量得分為 ${scores['朱雀']}，這表明您在表達和感染力方面有顯著優勢。`,

        '勾陳': `根據您的測驗結果，您屬於「勾陳」類型的人格特質。這表示您具有以下核心特徵：

• 穩定可靠：您是團隊中可信賴的基石，做事有條不紊
• 注重細節：您對細節有敏銳的觀察力，確保工作品質
• 執行力強：您擅長將計劃轉化為具體行動，堅持到底

您的勾陳能量得分為 ${scores['勾陳']}，這表明您在穩定性和執行力方面有顯著優勢。`,

        '螣蛇': `根據您的測驗結果，您屬於「螣蛇」類型的人格特質。這表示您具有以下核心特徵：

• 洞察人心：您能敏銳感知他人的情緒和需求
• 協調能力：您擅長化解衝突，促進團隊和諧
• 時機判斷：您對時機有精準的把握，知道何時行動最合適

您的螣蛇能量得分為 ${scores['螣蛇']}，這表明您在洞察和協調方面有顯著優勢。`,

        '白虎': `根據您的測驗結果，您屬於「白虎」類型的人格特質。這表示您具有以下核心特徵：

• 決策果斷：您能在壓力下快速做出決定，不拖泥帶水
• 行動迅速：您重視效率，總是第一時間採取行動
• 目標導向：您清楚自己的目標，並會全力以赴達成

您的白虎能量得分為 ${scores['白虎']}，這表明您在決策和行動力方面有顯著優勢。`,

        '玄武': `根據您的測驗結果，您屬於「玄武」類型的人格特質。這表示您具有以下核心特徵：

• 深度思考：您喜歡深入分析問題，不滿足於表面答案
• 策略規劃：您擅長制定長遠計劃，考慮各種可能性
• 冷靜智慧：您在壓力下保持冷靜，用智慧解決問題

您的玄武能量得分為 ${scores['玄武']}，這表明您在分析和規劃方面有顯著優勢。`
    };

    return baseAnalysis[beastType] || '您的人格特質具有獨特性，需要進一步探索。';
}

// 能量優勢分析
async function generateStrengthsAnalysis(beastType, scores) {
    const strengthsData = {
        '青龍': `您的青龍能量在六獸中表現突出，具體優勢包括：

🎯 核心優勢領域：
• 創意發想與創新思維
• 快速適應環境變化
• 突破傳統框架限制
• 多元角度思考問題

📊 能量分布分析：
您的創意能量（${scores['青龍']}分）讓您在需要創新和變革的環境中如魚得水。`,

        '朱雀': `您的朱雀能量在六獸中表現突出，具體優勢包括：

🎯 核心優勢領域：
• 情感表達與溝通藝術
• 團隊激勵與士氣提升
• 人際關係建立維護
• 公開演說與說服力

📊 能量分布分析：
您的表達能量（${scores['朱雀']}分）讓您在需要人際互動和情感連結的場合中表現出色。`,

        '勾陳': `您的勾陳能量在六獸中表現突出，具體優勢包括：

🎯 核心優勢領域：
• 系統建立與維護
• 細節掌控與品質保證
• 穩定執行與可靠性
• 長期堅持與耐力

📊 能量分布分析：
您的穩定能量（${scores['勾陳']}分）讓您在需要可靠性和持續性的工作中表現卓越。`,

        '螣蛇': `您的螣蛇能量在六獸中表現突出，具體優勢包括：

🎯 核心優勢領域：
• 人際洞察與情感理解
• 衝突協調與關係修復
• 時機判斷與策略調整
• 團隊和諧與凝聚力

📊 能量分布分析：
您的洞察能量（${scores['螣蛇']}分）讓您在需要敏感度和協調能力的環境中發揮關鍵作用。`,

        '白虎': `您的白虎能量在六獸中表現突出，具體優勢包括：

🎯 核心優勢領域：
• 快速決策與危機處理
• 目標達成與效率優化
• 壓力承受與挑戰應對
• 行動領導與結果導向

📊 能量分布分析：
您的行動能量（${scores['白虎']}分）讓您在需要速度和決斷力的情境中表現優異。`,

        '玄武': `您的玄武能量在六獸中表現突出，具體優勢包括：

🎯 核心優勢領域：
• 深度分析與問題解決
• 長遠規劃與策略制定
• 邏輯思考與理性判斷
• 知識積累與智慧應用

📊 能量分布分析：
您的智慧能量（${scores['玄武']}分）讓您在需要深思熟慮和戰略規劃的任務中表現出色。`
    };

    return strengthsData[beastType] || '您的能量分布具有獨特性，需要進一步分析。';
}

// 職場發展建議
async function generateCareerAnalysis(beastType, summary) {
    const careerData = {
        '青龍': `💼 最適合您的職場領域：

• 創意產業：廣告、設計、內容創作
• 新創公司：產品開發、市場創新
• 行銷策劃：品牌策略、活動企劃
• 研發部門：技術創新、產品迭代

🚀 職場發展策略：
1. 尋找能發揮創意的環境
2. 主動爭取創新專案的領導機會
3. 建立創意作品集，展示您的獨特價值
4. 與不同領域人才交流，激發更多靈感`,

        '朱雀': `💼 最適合您的職場領域：

• 教育培訓：教師、講師、教練
• 公關行銷：品牌溝通、客戶關係
• 人力資源：員工發展、團隊建設
• 服務業：客戶服務、體驗設計

🚀 職場發展策略：
1. 選擇需要人際互動的工作環境
2. 發展公眾演說和表達能力
3. 建立廣泛的人脈網絡
4. 學習情緒管理，保持專業形象`,

        '勾陳': `💼 最適合您的職場領域：

• 行政管理：流程優化、系統維護
• 財務會計：預算控制、風險管理
• 品質管控：標準制定、品質保證
• 專案管理：進度追蹤、資源協調

🚀 職場發展策略：
1. 選擇制度完善的組織環境
2. 建立個人專業信譽和可靠性
3. 學習系統化思考和流程優化
4. 培養危機預防和管理能力`,

        '螣蛇': `💼 最適合您的職場領域：

• 人力資源：員工關係、組織發展
• 心理諮商：職涯輔導、情緒支持
• 業務協調：客戶關係、合作談判
• 策略分析：市場研究、競爭分析

🚀 職場發展策略：
1. 選擇需要人際敏感度的工作
2. 發展衝突管理和協調技巧
3. 建立信任關係網絡
4. 學習組織行為和心理學知識`,

        '白虎': `💼 最適合您的職場領域：

• 業務銷售：市場開拓、客戶開發
• 專案管理：進度控制、資源分配
• 運營管理：效率優化、流程改善
• 危機處理：緊急應變、問題解決

🚀 職場發展策略：
1. 選擇結果導向的工作環境
2. 發展目標管理和績效追蹤能力
3. 學習風險評估和決策技巧
4. 培養團隊領導和激勵能力`,

        '玄武': `💼 最適合您的職場領域：

• 研究開發：技術研究、產品設計
• 數據分析：商業分析、市場研究
• 策略規劃：長期規劃、資源配置
• 顧問服務：專業諮詢、問題診斷

🚀 職場發展策略：
1. 選擇需要深度思考的工作環境
2. 發展專業知識和技術能力
3. 學習系統分析和策略規劃
4. 培養知識管理和分享能力`
    };

    return careerData[beastType] || '您的職場發展需要根據具體情況進行規劃。';
}

// 人際關係分析
async function generateRelationshipsAnalysis(beastType, scores) {
    const relationshipsData = {
        '青龍': `🤝 人際關係特點：

• 優勢：帶給朋友新鮮感和創意啟發
• 挑戰：有時過於專注想法而忽略他人感受
• 適合的朋友類型：喜歡變化和冒險的人

💡 關係改善建議：
1. 學習傾聽他人的想法和需求
2. 在表達創意時考慮實際可行性
3. 建立持續的友誼，不只是一時的興趣
4. 找到能欣賞您創意的朋友圈`,

        '朱雀': `🤝 人際關係特點：

• 優勢：溫暖真誠，容易建立情感連結
• 挑戰：情緒波動可能影響關係穩定性
• 適合的朋友類型：重視情感交流的人

💡 關係改善建議：
1. 在情感表達中保持適度理性
2. 學習處理人際衝突的技巧
3. 建立多元化的社交圈
4. 找到情感支持與獨立空間的平衡`,

        '勾陳': `🤝 人際關係特點：

• 優勢：可靠穩定，朋友信賴您的承諾
• 挑戰：有時過於堅持原則缺乏彈性
• 適合的朋友類型：重視安全感和穩定性的人

💡 關係改善建議：
1. 在穩定中學習適度冒險
2. 接受朋友的不同生活方式
3. 學習表達情感和脆弱面
4. 找到傳統與創新的平衡點`,

        '螣蛇': `🤝 人際關係特點：

• 優勢：敏銳洞察，能理解他人深層需求
• 挑戰：可能過度解讀或承擔他人情緒
• 適合的朋友類型：需要情感理解和支持的人

💡 關係改善建議：
1. 建立清晰的人際界限
2. 學習區分他人的問題和自己的責任
3. 找到情緒釋放的健康方式
4. 在理解他人的同時保護自己`,

        '白虎': `🤝 人際關係特點：

• 優勢：直接坦率，朋友知道您的立場
• 挑戰：有時過於直接可能傷害他人感受
• 適合的朋友類型：欣賞效率和直接溝通的人

💡 關係改善建議：
1. 學習更細膩的表達方式
2. 在追求效率時考慮人情因素
3. 培養耐心聆聽的習慣
4. 找到目標導向與關係維護的平衡`,

        '玄武': `🤝 人際關係特點：

• 優勢：智慧理性，能提供有價值的建議
• 挑戰：有時過於理性顯得情感疏離
• 適合的朋友類型：重視深度交流和智慧碰撞的人

💡 關係改善建議：
1. 學習更直接的情感表達
2. 在理性分析中加入情感理解
3. 找到獨處與社交的平衡
4. 建立基於共同興趣的友誼`
    };

    return relationshipsData[beastType] || '您的人際關係模式具有獨特性。';
}

// 個人成長建議
async function generateGrowthAnalysis(beastType, summary) {
    const growthData = {
        '青龍': `🌱 個人成長重點：

• 短期目標（3-6個月）：
  - 將1-2個創意想法具體化實施
  - 建立每日專注時間，培養執行力
  - 學習專案管理基礎知識

• 中期目標（6-12個月）：
  - 完成一個完整的創意專案
  - 發展跨界合作能力
  - 建立個人創意作品集

• 長期發展（1年以上）：
  - 成為領域內的創新領導者
  - 建立創意團隊或社群
  - 發展系統化的創新方法`,

        '朱雀': `🌱 個人成長重點：

• 短期目標（3-6個月）：
  - 學習情緒管理技巧
  - 發展理性分析能力
  - 建立規律的生活作息

• 中期目標（6-12個月）：
  - 掌握專業溝通技巧
  - 發展公眾表達能力
  - 建立個人品牌形象

• 長期發展（1年以上）：
  - 成為情感智慧的導師
  - 發展團隊領導能力
  - 建立支持性的人際網絡`,

        '勾陳': `🌱 個人成長重點：

• 短期目標（3-6個月）：
  - 學習接受適度的不確定性
  - 嘗試小的改變和創新
  - 發展問題解決的多元方法

• 中期目標（6-12個月）：
  - 掌握變革管理技巧
  - 發展系統優化能力
  - 建立危機應對計劃

• 長期發展（1年以上）：
  - 成為穩定中的變革推動者
  - 發展組織發展專業能力
  - 建立可持續的運營模式`,

        '螣蛇': `🌱 個人成長重點：

• 短期目標（3-6個月）：
  - 學習建立健康的人際界限
  - 發展個人興趣和專長
  - 練習直接表達需求和感受

• 中期目標（6-12個月）：
  - 掌握衝突管理技巧
  - 發展團隊協調能力
  - 建立個人支持系統

• 長期發展（1年以上）：
  - 成為人際關係的專家
  - 發展組織發展顧問能力
  - 建立和諧的工作環境`,

        '白虎': `🌱 個人成長重點：

• 短期目標（3-6個月）：
  - 學習耐心和細節關注
  - 發展團隊協作技巧
  - 建立反思和覆盤習慣

• 中期目標（6-12個月）：
  - 掌握專案管理系統方法
  - 發展戰略思考能力
  - 建立持續學習計劃

• 長期發展（1年以上）：
  - 成為有效率的領導者
  - 發展組織變革能力
  - 建立高績效團隊文化`,

        '玄武': `🌱 個人成長重點：

• 短期目標（3-6個月）：
  - 學習快速決策和行動
  - 發展人際溝通技巧
  - 建立行動落實的習慣

• 中期目標（6-12個月）：
  - 掌握策略執行能力
  - 發展團隊領導技巧
  - 建立知識管理系統

• 長期發展（1年以上）：
  - 成為智慧行動的領導者
  - 發展組織學習能力
  - 建立創新與傳統的平衡`
    };

    return growthData[beastType] || '您的個人成長需要根據具體情況規劃。';
}

// 五行金錢卦解析
async function generateMoneyAnalysis(beastType, summary) {
    const moneyData = {
        '青龍': `💰 五行金錢卦解析：

• 財富屬性：木屬性財富（成長型、創新性）
• 適合投資：新興科技、創意產業、教育培訓
• 財富周期：春季最旺，適合啟動新計劃

🎯 財富建議：
1. 投資自己的創意和能力提升
2. 尋找創新領域的投資機會
3. 建立多元收入來源
4. 注意風險分散，避免過度投機

🔮 金錢卦象：
「青龍出海」象徵創新求財，適合開拓新市場和新領域，但需注意時機把握和風險控制。`,

        '朱雀': `💰 五行金錢卦解析：

• 財富屬性：火屬性財富（熱情型、人際性）
• 適合投資：服務業、娛樂產業、人際網絡
• 財富周期：夏季最旺，適合拓展人脈

🎯 財富建議：
1. 透過人際網絡創造財富機會
2. 投資個人品牌和形象建設
3. 發展知識變現的能力
4. 注意理性消費，建立儲蓄習慣

🔮 金錢卦象：
「朱雀展翅」象徵人脈生財，適合透過合作與分享創造價值，但需注意情感投資的理性判斷。`,

        '勾陳': `💰 五行金錢卦解析：

• 財富屬性：土屬性財富（穩定型、積累性）
• 適合投資：房地產、基礎建設、傳統產業
• 財富周期：四季皆宜，特別適合長期規劃

🎯 財富建議：
1. 建立穩健的財務規劃
2. 注重長期投資和資產配置
3. 發展專業技能的變現能力
4. 注意通膨風險，適度創新

🔮 金錢卦象：
「勾陳守城」象徵穩定積累，適合透過專業和堅持創造財富，但需注意在穩定中尋求適度突破。`,

        '螣蛇': `💰 五行金錢卦解析：

• 財富屬性：土屬性財富（靈活型、機會性）
• 適合投資：中介服務、咨詢業、時機性投資
• 財富周期：轉換期最旺，適合把握時機

🎯 財富建議：
1. 培養發現隱藏機會的能力
2. 發展資訊分析和判斷力
3. 建立靈活的財務策略
4. 注意過度猶豫可能錯失良機

🔮 金錢卦象：
「螣蛇繞樑」象徵時機生財，適合透過精準判斷和靈活應變創造價值，但需注意決策的及時性。`,

        '白虎': `💰 五行金錢卦解析：

• 財富屬性：金屬性財富（果斷型、行動性）
• 適合投資：科技業、製造業、效率優化
• 財富周期：秋季最旺，適合收穫成果

🎯 財富建議：
1. 透過效率和執行力創造價值
2. 投資提升效率和品質的技術
3. 發展規模化經營能力
4. 注意衝動決策，做好風險評估

🔮 金錢卦象：
「白虎下山」象徵行動生財，適合透過快速決策和有效執行創造財富，但需注意風險控制和管理。`,

        '玄武': `💰 五行金錢卦解析：

• 財富屬性：水屬性財富（智慧型、規劃性）
• 適合投資：知識產業、研究開發、長期投資
• 財富周期：冬季最旺，適合規劃佈局

🎯 財富建議：
1. 透過知識和智慧創造價值
2. 投資教育和能力提升
3. 發展系統化投資策略
4. 注意過度分析可能延誤行動

🔮 金錢卦象：
「玄武潛淵」象徵智慧生財，適合透過深度分析和長遠規劃創造財富，但需注意理論與實踐的結合。`
    };

    return moneyData[beastType] || '您的財富能量需要進一步分析。';
}

module.exports = router;
